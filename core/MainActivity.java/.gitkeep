package mazdady.core;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;
import androidx.appcompat.app.AppCompatActivity;
import mazdady.admin.AdminConfig;
import mazdady.ui.DynamicPopupManager;
import mazdady.ui.StarEffectManager;
import mazdady.user.UserManager;

public class MainActivity extends AppCompatActivity {
    private DynamicPopupManager popupManager;
    private TextView balanceView;
    private Button buyButton, sellButton;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // تحميل الإعدادات من السيرفر (يتم مرة واحدة)
        AdminConfig.getInstance().loadFromServer();

        // ربط العناصر من التخطيط
        balanceView = findViewById(R.id.balance_view);
        buyButton = findViewById(R.id.buy_button);
        sellButton = findViewById(R.id.sell_button);

        // تهيئة مدير الـ Popups
        popupManager = new DynamicPopupManager(this);

        // تحميل رصيد المستخدم
        double balance = UserManager.getInstance().getCurrentUser().getBalance();
        balanceView.setText("الرصيد: " + String.format("%.2f", balance) + " MAZDADY");

        // إعداد أحداث النقر
        buyButton.setOnClickListener(v -> showBuyPopup());
        sellButton.setOnClickListener(v -> showSellPopup());

        // عرض تأثير النجوم إذا كان هناك ربح حديث
        if (UserManager.getInstance().getCurrentUser().hasRecentProfit()) {
            StarEffectManager.showStar(this, findViewById(R.id.main_container));
        }
    }

    private void showBuyPopup() {
        String content = "اختر عدد العملات التي تريد شراؤها:\n\n" +
                        "• الحد الأدنى: 1 MAZDADY\n" +
                        "• يمكنك استخدام رصيدك أو محفظتك الرقمية.\n\n" +
                        "ملاحظة: سعر الشراء الحالي يعتمد على نشاط السوق.";
        popupManager.showScrollablePopup("شراء MAZDADY", content);
    }

    private void showSellPopup() {
        String content = "حدد كمية العملات التي تريد بيعها:\n\n" +
                        "• سيتم خصم ضريبة السحب تلقائيًا.\n" +
                        "• الأرباح تُحول إلى محفظتك بعد التحقق.\n\n" +
                        "تنبيه: لا يمكن السحب إلا بعد توثيق الهوية.";
        popupManager.showScrollablePopup("بيع MAZDADY", content);
    }
}