package mazdady.core;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;
import androidx.appcompat.app.AppCompatActivity;
import mazdady.admin.AdminConfig;
import mazdady.ui.DynamicPopupManager;
import mazdady.ui.StarEffectManager;
import mazdady.user.UserManager;

public class MainActivity extends AppCompatActivity {
    private DynamicPopupManager popupManager;
    private TextView balanceView;
    private Button buyButton, sellButton;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        AdminConfig.getInstance().loadFromServer();

        balanceView = findViewById(R.id.balance_view);
        buyButton = findViewById(R.id.buy_button);
        sellButton = findViewById(R.id.sell_button);

        popupManager = new DynamicPopupManager(this);

        double balance = UserManager.getInstance().getCurrentUser().getBalance();
        balanceView.setText("الرصيد: " + String.format("%.2f", balance) + " MAZDADY");

        buyButton.setOnClickListener(v -> showBuyPopup());
        sellButton.setOnClickListener(v -> showSellPopup());

        if (UserManager.getInstance().getCurrentUser().hasRecentProfit()) {
            StarEffectManager.showStar(this, findViewById(R.id.main_container));
        }
    }

    private void showBuyPopup() {
        String content = "اختر عدد العملات التي تريد شراؤها:\n\n" +
                        "• الحد الأدنى: 1 MAZDADY\n" +
                        "• يمكنك استخدام رصيدك أو محفظتك الرقمية.\n\n" +
                        "ملاحظة: سعر الشراء الحالي يعتمد على نشاط السوق.";
        popupManager.showScrollablePopup("شراء MAZDADY", content);
    }

    private void showSellPopup() {
        String content = "حدد كمية العملات التي تريد بيعها:\n\n" +
                        "• سيتم خصم ضريبة السحب تلقائيًا.\n" +
                        "• الأرباح تُحول إلى محفظتك بعد التحقق.\n\n" +
                        "تنبيه: لا يمكن السحب إلا بعد توثيق الهوية.";
        popupManager.showScrollablePopup("بيع MAZDADY", content);
    }
}
@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    // ... (الكود السابق)

    // إضافة الزر العائم
    setupFloatingAdButton();
}

private void setupFloatingAdButton() {
    AdminConfig.UIConfig uiConfig = AdminConfig.getInstance().getUIConfig();
    if (!uiConfig.getFloatingAdConfig().isEnabled()) return;

    FloatingAdButton adButton = new FloatingAdButton(this, null);
    adButton.configure(
        uiConfig.getFloatingAdConfig().getDisplayDuration(),
        uiConfig.getFloatingAdConfig().getHideDuration(),
        uiConfig.getFloatingAdConfig().getAdImageUrl()
    );

    FrameLayout.LayoutParams params = new FrameLayout.LayoutParams(
        120, 120, Gravity.BOTTOM | Gravity.END
    );
    params.rightMargin = 20;
    params.bottomMargin = 20;

    ((ViewGroup) findViewById(android.R.id.content)).addView(adButton, params);
}