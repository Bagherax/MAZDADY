package mazdady.core;

import mazdady.security.DeviceFingerprint;
import mazdady.security.RootDetection;
import mazdady.security.AppIntegrityChecker;
import mazdady.security.SecurityMonitor;

import android.content.Context;

/**
 * مدير الأمان مع دعم الحماية المتقدمة
 * يتبع نمط Facade لتوفير واجهة موحدة للأمان
 */
public final class SecurityMgr {
    private final Context context;
    private final SecurityMonitor securityMonitor;
    private static SecurityMgr instance;

    private SecurityMgr(Context context) {
        this.context = context;
        this.securityMonitor = new SecurityMonitor(context);
    }

    public static synchronized SecurityMgr getInstance(Context context) {
        if (instance == null) {
            instance = new SecurityMgr(context.getApplicationContext());
        }
        return instance;
    }

    /**
     * التحقق من سلامة التطبيق
     */
    public boolean isAppIntegrityValid() {
        boolean integrityValid = AppIntegrityChecker.isAppIntegrityValid(context);
        if (!integrityValid) {
            securityMonitor.reportSuspiciousActivity("MODIFIED_APP");
        }
        return integrityValid;
    }

    /**
     * التحقق من جذور الجهاز
     */
    public boolean isDeviceRooted() {
        boolean rooted = RootDetection.isDeviceRooted();
        if (rooted) {
            securityMonitor.reportSuspiciousActivity("ROOTED_DEVICE");
        }
        return rooted;
    }

    /**
     * الحصول على بصمة الجهاز
     */
    public String getDeviceFingerprint() {
        return DeviceFingerprint.getUniqueDeviceId(context);
    }

    /**
     * التحقق من الأمان الشامل
     */
    public SecurityStatus performSecurityCheck() {
        boolean integrityValid = isAppIntegrityValid();
        boolean deviceSecure = !isDeviceRooted();
        
        if (integrityValid && deviceSecure) {
            return new SecurityStatus(true, "SECURITY_CHECK_PASSED");
        } else {
            return new SecurityStatus(false, 
                "Integrity: " + integrityValid + ", Rooted: " + !deviceSecure);
        }
    }

    /**
     * حالة الأمان
     */
    public static final class SecurityStatus {
        private final boolean secure;
        private final String message;

        public SecurityStatus(boolean secure, String message) {
            this.secure = secure;
            this.message = message;
        }

        public boolean isSecure() { return secure; }
        public String getMessage() { return message; }
    }
}