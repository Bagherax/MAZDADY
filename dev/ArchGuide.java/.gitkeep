package mazdady.dev;

import mazdady.admin.AdminConfig;
import mazdady.user.User;
import mazdady.user.UserManager;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.function.Supplier;

/**
 * Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø§Ø±Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Singleton Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ø¢Ù…Ù†Ø©
 */
public final class ArchGuide {
    private final Map<String, ArchitectureComponent> components = new ConcurrentHashMap<>();
    private static ArchGuide instance;

    private ArchGuide() {
        initializeArchitecture();
    }

    public static synchronized ArchGuide getInstance() {
        if (instance == null) {
            instance = new ArchGuide();
        }
        return instance;
    }

    private void initializeArchitecture() {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
        AdminConfig adminConfig = AdminConfig.getInstance();
        AdminConfig.ArchitectureConfig archConfig = adminConfig.getArchitectureConfig();
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        components.put("CORE", new ArchitectureComponent(
            "Core Layer",
            "Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©",
            "core/",
            archConfig.getCoreLayerPriority()
        ));
        
        components.put("USER", new ArchitectureComponent(
            "User Layer",
            "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§ØªØŒ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª",
            "user/",
            archConfig.getUserLayerPriority()
        ));
        
        components.put("WALLET", new ArchitectureComponent(
            "Wallet Layer",
            "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª",
            "wallet/",
            archConfig.getWalletLayerPriority()
        ));
        
        components.put("TRADING", new ArchitectureComponent(
            "Trading Layer",
            "Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆÙØ±Ù‚ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ©",
            "trading/, team/",
            archConfig.getTradingLayerPriority()
        ));
        
        components.put("ADMIN", new ArchitectureComponent(
            "Admin Layer",
            "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©",
            "admin/",
            archConfig.getAdminLayerPriority()
        ));
        
        components.put("SECURITY", new ArchitectureComponent(
            "Security Layer",
            "Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©",
            "security/, auth/",
            archConfig.getSecurityLayerPriority()
        ));
        
        components.put("UI", new ArchitectureComponent(
            "UI Layer",
            "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©",
            "ui/",
            archConfig.getUiLayerPriority()
        ));
        
        components.put("BOT", new ArchitectureComponent(
            "Bot Layer",
            "Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¯Ø¹Ù…",
            "bot/",
            archConfig.getBotLayerPriority()
        ));
        
        components.put("SOCIAL", new ArchitectureComponent(
            "Social Layer",
            "Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª",
            "social/",
            archConfig.getSocialLayerPriority()
        ));
        
        components.put("WITHDRAWAL", new ArchitectureComponent(
            "Withdrawal Layer",
            "Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¶Ø±Ø§Ø¦Ø¨",
            "withdrawal/",
            archConfig.getWithdrawalLayerPriority()
        ));
        
        System.out.println("ARCH GUIDE: Initialized with " + components.size() + " architecture components");
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØµÙ Ù…ÙƒÙˆÙ† Ø§Ù„Ø¹Ù…Ø§Ø±Ø©
     */
    public String getComponentDescription(String componentName) {
        ArchitectureComponent component = components.get(componentName);
        return component != null ? component.getDescription() : "Component not found";
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ù…ÙƒÙˆÙ† Ø§Ù„Ø¹Ù…Ø§Ø±Ø©
     */
    public String getComponentPath(String componentName) {
        ArchitectureComponent component = components.get(componentName);
        return component != null ? component.getPath() : "unknown/";
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
     */
    public void updatePrioritiesFromConfig(AdminConfig.ArchitectureConfig config) {
        if (config == null) return;
        
        components.get("CORE")?.setPriority(config.getCoreLayerPriority());
        components.get("USER")?.setPriority(config.getUserLayerPriority());
        components.get("WALLET")?.setPriority(config.getWalletLayerPriority());
        components.get("TRADING")?.setPriority(config.getTradingLayerPriority());
        components.get("ADMIN")?.setPriority(config.getAdminLayerPriority());
        components.get("SECURITY")?.setPriority(config.getSecurityLayerPriority());
        components.get("UI")?.setPriority(config.getUiLayerPriority());
        components.get("BOT")?.setPriority(config.getBotLayerPriority());
        components.get("SOCIAL")?.setPriority(config.getSocialLayerPriority());
        components.get("WITHDRAWAL")?.setPriority(config.getWithdrawalLayerPriority());
        
        System.out.println("ARCH GUIDE: Priorities updated from admin config");
    }

    /**
     * Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„
     */
    public String getFullGuide() {
        StringBuilder guide = new StringBuilder();
        guide.append("ğŸ—ï¸ MAZDADY ARCHITECTURE GUIDE\n");
        guide.append("================================\n\n");
        
        // ÙØ±Ø² Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
        components.values().stream()
            .sorted((c1, c2) -> Integer.compare(c2.getPriority(), c1.getPriority()))
            .forEach(component -> {
                guide.append(String.format(
                    "ğŸ”· %s (Priority: %d)\n" +
                    "   Ø§Ù„ÙˆØµÙ: %s\n" +
                    "   Ø§Ù„Ù…Ø³Ø§Ø±: %s\n\n",
                    component.getName(),
                    component.getPriority(),
                    component.getDescription(),
                    component.getPath()
                ));
            });
        
        return guide.toString();
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ù†ÙŠØ©
     */
    public ValidationResult validateArchitecture() {
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            String[] requiredComponents = {"CORE", "USER", "WALLET", "TRADING", "ADMIN", "SECURITY"};
            for (String component : requiredComponents) {
                if (!components.containsKey(component)) {
                    return ValidationResult.failure("Missing required component: " + component);
                }
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª
            for (ArchitectureComponent component : components.values()) {
                if (component.getPriority() < 1 || component.getPriority() > 10) {
                    return ValidationResult.failure("Invalid priority for component: " + component.getName());
                }
            }
            
            System.out.println("ARCH GUIDE: Architecture validation passed");
            return ValidationResult.success("Architecture is valid and complete");
            
        } catch (Exception e) {
            return ValidationResult.failure("Architecture validation failed: " + e.getMessage());
        }
    }

    /**
     * Ù…ÙƒÙˆÙ† Ø§Ù„Ø¹Ù…Ø§Ø±Ø©
     */
    public static final class ArchitectureComponent {
        private final String name;
        private final String description;
        private final String path;
        private volatile int priority;

        public ArchitectureComponent(String name, String description, String path, int priority) {
            this.name = name;
            this.description = description;
            this.path = path;
            this.priority = priority;
        }

        // Getters
        public String getName() { return name; }
        public String getDescription() { return description; }
        public String getPath() { return path; }
        public int getPriority() { return priority; }
        
        // Setters
        public void setPriority(int priority) { this.priority = priority; }
        
        @Override
        public String toString() {
            return "ArchitectureComponent{" +
                "name='" + name + '\'' +
                ", priority=" + priority +
                ", path='" + path + '\'' +
                '}';
        }
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚
     */
    public static final class ValidationResult {
        private final boolean success;
        private final String message;

        private ValidationResult(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public static ValidationResult success(String message) {
            return new ValidationResult(true, message);
        }

        public static ValidationResult failure(String message) {
            return new ValidationResult(false, message);
        }

        public boolean isSuccess() { return success; }
        public String getMessage() { return message; }
    }
}