package mazdady.dev;

import android.view.View;
import android.widget.Button;
import android.widget.TextView;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CopyOnWriteArrayList;

/**
 * Ù…Ø¯ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Strategy Ù„ÙØµÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
 */
public final class UITests {
    private final CopyOnWriteArrayList<UITest> tests = new CopyOnWriteArrayList<>();
    private static final UITests INSTANCE = new UITests();

    private UITests() {
        initializeTests();
    }

    public static UITests getInstance() {
        return INSTANCE;
    }

    private void initializeTests() {
        tests.add(new TradingUITest());
        tests.add(new PopupUITest());
        tests.add(new LocalizationUITest());
    }

    /**
     * ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
     */
    public CompletableFuture<UIReport> runAllTestsAsync() {
        return CompletableFuture.supplyAsync(() -> {
            UIReport report = new UIReport();
            for (UITest test : tests) {
                report.merge(test.run());
            }
            return report;
        });
    }

    /**
     * ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
     */
    public static void runAllTests() {
        UIReport report = getInstance().runAllTestsAsync().join();
        System.out.println(report.getSummary());
    }

    /**
     * ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
     */
    @FunctionalInterface
    public interface UITest {
        UIReport run();
    }

    /**
     * ØªÙ‚Ø±ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
     */
    public static final class UIReport {
        private int passed = 0;
        private int failed = 0;
        private final CopyOnWriteArrayList<String> failures = new CopyOnWriteArrayList<>();

        public void addPassed() { passed++; }
        public void addFailed(String testName, String reason) {
            failed++;
            failures.add(testName + ": " + reason);
        }

        public void merge(UIReport other) {
            this.passed += other.passed;
            this.failed += other.failed;
            this.failures.addAll(other.failures);
        }

        public String getSummary() {
            return String.format(
                "ğŸ“± UI TESTS: %d passed, %d failed\n%s",
                passed, failed,
                failures.isEmpty() ? "" : "Failures:\n" + String.join("\n", failures)
            );
        }
    }

    // --- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ù…Ø®ØµØµØ© ---
    private static final class TradingUITest implements UITest {
        @Override
        public UIReport run() {
            UIReport report = new UIReport();
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„
                TextView balanceView = mockTextView("Ø§Ù„Ø±ØµÙŠØ¯: 1000.00 MAZDADY");
                Button buyButton = mockButton("Ø´Ø±Ø§Ø¡");
                Button sellButton = mockButton("Ø¨ÙŠØ¹");
                
                if (!balanceView.getText().toString().contains("MAZDADY")) {
                    throw new AssertionError("Balance view should display MAZDADY");
                }
                if (!buyButton.getText().toString().equals("Ø´Ø±Ø§Ø¡")) {
                    throw new AssertionError("Buy button should display 'Ø´Ø±Ø§Ø¡'");
                }
                report.addPassed();
            } catch (Exception e) {
                report.addFailed("TradingUITest", e.getMessage());
            }
            return report;
        }
    }

    private static final class PopupUITest implements UITest {
        @Override
        public UIReport run() {
            UIReport report = new UIReport();
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Popups
                mazdady.ui.DynamicPopupManager popupManager = 
                    new mazdady.ui.DynamicPopupManager(null);
                // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¶ Popup
                report.addPassed();
            } catch (Exception e) {
                report.addFailed("PopupUITest", e.getMessage());
            }
            return report;
        }
    }

    private static final class LocalizationUITest implements UITest {
        @Override
        public UIReport run() {
            UIReport report = new UIReport();
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø©
                mazdady.i18n.TranslationManager translator = 
                    new mazdady.i18n.TranslationManager(null);
                String translated = translator.getString("buy_button");
                if (translated == null || translated.isEmpty()) {
                    throw new AssertionError("Translation should not be empty");
                }
                report.addPassed();
            } catch (Exception e) {
                report.addFailed("LocalizationUITest", e.getMessage());
            }
            return report;
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© ---
    private static TextView mockTextView(String text) {
        return new TextView(null) {
            @Override
            public CharSequence getText() {
                return text;
            }
        };
    }

    private static Button mockButton(String text) {
        return new Button(null) {
            @Override
            public CharSequence getText() {
                return text;
            }
        };
    }
}