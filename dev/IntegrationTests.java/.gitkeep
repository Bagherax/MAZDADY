package mazdady.dev;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CopyOnWriteArrayList;

/**
 * Ù…Ø¯ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Observer Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬
 */
public final class IntegrationTests {
    private final CopyOnWriteArrayList<IntegrationTest> tests = new CopyOnWriteArrayList<>();
    private static final IntegrationTests INSTANCE = new IntegrationTests();

    private IntegrationTests() {
        initializeTests();
    }

    public static IntegrationTests getInstance() {
        return INSTANCE;
    }

    private void initializeTests() {
        tests.add(new UserWalletIntegrationTest());
        tests.add(new TradingAdIntegrationTest());
        tests.add(new SecurityAuthIntegrationTest());
    }

    /**
     * ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„ ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
     */
    public CompletableFuture<IntegrationReport> runAllTestsAsync() {
        return CompletableFuture.supplyAsync(() -> {
            IntegrationReport report = new IntegrationReport();
            for (IntegrationTest test : tests) {
                report.merge(test.run());
            }
            return report;
        });
    }

    /**
     * ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„
     */
    public static void runAllTests() {
        IntegrationReport report = getInstance().runAllTestsAsync().join();
        System.out.println(report.getSummary());
    }

    /**
     * ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙƒØ§Ù…Ù„
     */
    @FunctionalInterface
    public interface IntegrationTest {
        IntegrationReport run();
    }

    /**
     * ØªÙ‚Ø±ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙƒØ§Ù…Ù„
     */
    public static final class IntegrationReport {
        private int passed = 0;
        private int failed = 0;
        private final CopyOnWriteArrayList<String> failures = new CopyOnWriteArrayList<>();

        public void addPassed() { passed++; }
        public void addFailed(String testName, String reason) {
            failed++;
            failures.add(testName + ": " + reason);
        }

        public void merge(IntegrationReport other) {
            this.passed += other.passed;
            this.failed += other.failed;
            this.failures.addAll(other.failures);
        }

        public String getSummary() {
            return String.format(
                "ğŸ”— INTEGRATION TESTS: %d passed, %d failed\n%s",
                passed, failed,
                failures.isEmpty() ? "" : "Failures:\n" + String.join("\n", failures)
            );
        }
    }

    // --- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙƒØ§Ù…Ù„ Ù…Ø®ØµØµØ© ---
    private static final class UserWalletIntegrationTest implements IntegrationTest {
        @Override
        public IntegrationReport run() {
            IntegrationReport report = new IntegrationReport();
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ø­ÙØ¸Ø©
                mazdady.user.User user = new mazdady.user.User("integration_test");
                mazdady.wallet.WalletManager wallet = new mazdady.wallet.WalletManager();
                wallet.depositMAZDADY(1000.0);
                user.setBalance(wallet.getBalance());
                
                if (user.getBalance() != 1000.0) {
                    throw new AssertionError("User balance should match wallet balance");
                }
                report.addPassed();
            } catch (Exception e) {
                report.addFailed("UserWalletIntegrationTest", e.getMessage());
            }
            return report;
        }
    }

    private static final class TradingAdIntegrationTest implements IntegrationTest {
        @Override
        public IntegrationReport run() {
            IntegrationReport report = new IntegrationReport();
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙƒØ§Ù…Ù„ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
                mazdady.trading.PriceEngine engine = new mazdady.trading.PriceEngine();
                mazdady.ad.AdManager adManager = mazdady.ad.AdManager.getInstance();
                
                // ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© ØªØ¯Ø§ÙˆÙ„
                engine.executeBuyOrder("test_user", 50);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©
                mazdady.ad.AdCampaign campaign = new mazdady.ad.AdCampaign.Builder()
                    .userId("test_user")
                    .platform(mazdady.ad.AdCampaign.Platform.TIKTOK)
                    .contentUrl("https://tiktok.com/test")
                    .goal(mazdady.ad.AdCampaign.Goal.VIEWS)
                    .targetCount(100)
                    .budget(10.0)
                    .build();
                
                report.addPassed();
            } catch (Exception e) {
                report.addFailed("TradingAdIntegrationTest", e.getMessage());
            }
            return report;
        }
    }

    private static final class SecurityAuthIntegrationTest implements IntegrationTest {
        @Override
        public IntegrationReport run() {
            IntegrationReport report = new IntegrationReport();
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                mazdady.auth.LoginManager loginManager = mazdady.auth.LoginManager.getInstance();
                mazdady.security.SecurityMgr securityMgr = mazdady.security.SecurityMgr.getInstance(null);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                if (!securityMgr.isAppIntegrityValid()) {
                    throw new AssertionError("App integrity should be valid in tests");
                }
                report.addPassed();
            } catch (Exception e) {
                report.addFailed("SecurityAuthIntegrationTest", e.getMessage());
            }
            return report;
        }
    }
}