package mazdady.social;

import mazdady.user.User;
import mazdady.user.UserManager;
import mazdady.admin.AdminConfig;

import java.time.Instant;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.function.BiFunction;

/**
 * Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Strategy Ù„ÙØµÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª
 */
public final class Achievements {
    private final Map<String, Achievement> achievements = new ConcurrentHashMap<>();
    private static Achievements instance;

    private Achievements() {
        initializeAchievements();
    }

    public static synchronized Achievements getInstance() {
        if (instance == null) {
            instance = new Achievements();
        }
        return instance;
    }

    private void initializeAchievements() {
        // Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        achievements.put("level_1", new Achievement(
            "level_1",
            "Ø£ÙˆÙ„ Ù…Ø³ØªÙˆÙ‰",
            "Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„",
            10,
            (user, progress) -> user.getLevel() >= 1
        ));
        
        achievements.put("level_5", new Achievement(
            "level_5",
            "Ø®Ø¨ÙŠØ± Ù…Ø¨ØªØ¯Ø¦",
            "Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ù…Ø³",
            50,
            (user, progress) -> user.getLevel() >= 5
        ));
        
        achievements.put("level_10", new Achievement(
            "level_10",
            "Ù…Ø§Ø¬Ø³ØªÙŠØ± Ø§Ù„ØªØ¯Ø§ÙˆÙ„",
            "Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø§Ø´Ø±",
            100,
            (user, progress) -> user.getLevel() >= 10
        ));
        
        achievements.put("level_20", new Achievement(
            "level_20",
            "Ø£Ø³ØªØ§Ø° Ø§Ù„ØªØ¯Ø§ÙˆÙ„",
            "Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø´Ø±ÙŠÙ†",
            200,
            (user, progress) -> user.getLevel() >= 20
        ));
        
        System.out.println("ACHIEVEMENTS: Initialized " + achievements.size() + " achievements");
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public void checkAchievementAsync(String userId, String achievementId) {
        new Thread(() -> {
            try {
                User user = UserManager.getInstance(null).getUserById(userId);
                if (user == null) {
                    System.err.println("ACHIEVEMENTS: User not found - " + userId);
                    return;
                }
                
                Achievement achievement = achievements.get(achievementId);
                if (achievement == null) {
                    System.err.println("ACHIEVEMENTS: Achievement not found - " + achievementId);
                    return;
                }
                
                int progress = calculateAchievementProgress(user, achievementId);
                boolean unlocked = achievement.condition.test(user, progress);
                
                if (unlocked && !user.hasAchievement(achievementId)) {
                    unlockAchievement(user, achievement);
                }
                
            } catch (Exception e) {
                System.err.println("ACHIEVEMENT CHECK ERROR: " + e.getMessage());
            }
        }).start();
    }

    private int calculateAchievementProgress(User user, String achievementId) {
        switch (achievementId) {
            case "level_1":
            case "level_5":
            case "level_10":
            case "level_20":
                return user.getLevel();
            default:
                return 0;
        }
    }

    private void unlockAchievement(User user, Achievement achievement) {
        try {
            // Ù…Ù†Ø­ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
            user.addAchievement(achievement.id);
            
            // Ù…Ù†Ø­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠØ©
            user.addCommunityPoints(achievement.rewardPoints);
            
            // Ù…Ù†Ø­ Ø§Ù„Ø´Ø§Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
            grantAchievementBadge(user, achievement);
            
            // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
            notifyAchievementUnlocked(user.getUserId(), achievement);
            
            System.out.println("ACHIEVEMENTS: Unlocked " + achievement.name + " for user " + user.getUserId());
            
        } catch (Exception e) {
            System.err.println("ACHIEVEMENT UNLOCK ERROR: " + e.getMessage());
        }
    }

    private void grantAchievementBadge(User user, Achievement achievement) {
        try {
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ù…Ù†Ø­ Ø§Ù„Ø´Ø§Ø±Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
            String badgeEmoji = getBadgeEmojiForAchievement(achievement.id);
            user.addBadge(badgeEmoji, achievement.name);
            
            System.out.println("ACHIEVEMENTS: Granted badge " + badgeEmoji + " for " + achievement.name);
            
        } catch (Exception e) {
            System.err.println("BADGE GRANT ERROR: " + e.getMessage());
        }
    }

    private String getBadgeEmojiForAchievement(String achievementId) {
        switch (achievementId) {
            case "level_1": return "ğŸ¥‰";
            case "level_5": return "ğŸ¥ˆ";
            case "level_10": return "ğŸ¥‡";
            case "level_20": return "ğŸ†";
            default: return "â­";
        }
    }

    private void notifyAchievementUnlocked(String userId, Achievement achievement) {
        try {
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            System.out.println("ACHIEVEMENT NOTIFICATION: " + userId + " unlocked " + achievement.name);
            
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
            mazdady.admin.AdminDashboard.getInstance().notifyAchievementUnlocked(userId, achievement);
            
        } catch (Exception e) {
            System.err.println("ACHIEVEMENT NOTIFICATION ERROR: " + e.getMessage());
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§
     */
    public void updateAchievementsFromConfig(AdminConfig.AchievementConfig config) {
        if (config == null) return;
        
        try {
            Map<String, AdminConfig.AchievementConfig.AchievementDefinition> definitions = 
                config.getAchievementDefinitions();
            
            achievements.clear();
            definitions.forEach((id, definition) -> {
                achievements.put(id, new Achievement(
                    id,
                    definition.getName(),
                    definition.getDescription(),
                    definition.getRewardPoints(),
                    (user, progress) -> user.getLevel() >= definition.getRequiredLevel()
                ));
            });
            
            System.out.println("ACHIEVEMENTS: Updated from admin config - " + achievements.size() + " achievements");
            
        } catch (Exception e) {
            System.err.println("ACHIEVEMENTS UPDATE ERROR: " + e.getMessage());
        }
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¥Ù†Ø¬Ø§Ø² Ù…Ø®ØµØµ
     */
    public void addCustomAchievement(String id, String name, String description, 
                                   int rewardPoints, BiFunction<User, Integer, Boolean> condition) {
        if (id != null && name != null && condition != null) {
            Achievement achievement = new Achievement(id, name, description, rewardPoints, condition);
            achievements.put(id, achievement);
            System.out.println("ACHIEVEMENTS: Added custom achievement - " + name);
        }
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø¥Ù†Ø¬Ø§Ø² Ù…Ø®ØµØµ
     */
    public void removeCustomAchievement(String id) {
        if (id != null) {
            Achievement removed = achievements.remove(id);
            if (removed != null) {
                System.out.println("ACHIEVEMENTS: Removed custom achievement - " + removed.name);
            }
        }
    }

    // --- Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² ---
    private static final class Achievement {
        private final String id;
        private final String name;
        private final String description;
        private final int rewardPoints;
        private final BiFunction<User, Integer, Boolean> condition;

        public Achievement(String id, String name, String description, 
                          int rewardPoints, BiFunction<User, Integer, Boolean> condition) {
            this.id = id;
            this.name = name;
            this.description = description;
            this.rewardPoints = rewardPoints;
            this.condition = condition;
        }
    }

    // --- Getters ---
    public int getAchievementCount() { return achievements.size(); }
    public boolean hasAchievement(String id) { return achievements.containsKey(id); }
    public Map<String, Achievement> getAchievements() { return new ConcurrentHashMap<>(achievements); }
    
    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void reset() {
        achievements.clear();
        initializeAchievements();
        System.out.println("ACHIEVEMENTS: Reset completed");
    }
}