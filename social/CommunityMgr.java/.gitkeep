package mazdady.social;

import mazdady.user.User;
import mazdady.user.UserManager;

import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicLong;

/**
 * مدير المجتمع مع دعم الأنشطة الاجتماعية
 * يتبع نمط Singleton مع تهيئة آمنة
 */
public final class CommunityMgr {
    private final ConcurrentHashMap<String, CommunityActivity> activities = new ConcurrentHashMap<>();
    private final AtomicLong totalCommunityPoints = new AtomicLong(0);
    private static CommunityMgr instance;

    private CommunityMgr() {}

    public static synchronized CommunityMgr getInstance() {
        if (instance == null) {
            instance = new CommunityMgr();
        }
        return instance;
    }

    /**
     * تسجيل نشاط اجتماعي
     */
    public void registerActivity(String userId, ActivityType type, double impact) {
        CommunityActivity activity = new CommunityActivity(userId, type, impact, System.currentTimeMillis());
        activities.put("activity_" + System.currentTimeMillis(), activity);
        
        // منح نقاط مجتمعية
        int points = calculateCommunityPoints(type, impact);
        User user = UserManager.getInstance(null).getCurrentUser();
        if (user.getUserId().equals(userId)) {
            user.addCommunityPoints(points);
            totalCommunityPoints.addAndGet(points);
        }
        
        System.out.println("COMMUNITY ACTIVITY: " + type + " by " + userId + " (" + points + " points)");
    }

    private int calculateCommunityPoints(ActivityType type, double impact) {
        switch (type) {
            case TRADING:
                return (int) (impact * 0.1); // 0.1 نقطة لكل MAZDADY
            case AD_CAMPAIGN:
                return (int) (impact * 0.5); // 0.5 نقطة لكل MAZDADY
            case REFERRAL:
                return 50; // 50 نقطة لكل إحالة
            case ACHIEVEMENT:
                return 100; // 100 نقطة لكل إنجاز
            default:
                return 10;
        }
    }

    /**
     * الحصول على إجمالي نقاط المجتمع
     */
    public long getTotalCommunityPoints() {
        return totalCommunityPoints.get();
    }

    /**
     * نشاط المجتمع
     */
    private static final class CommunityActivity {
        private final String userId;
        private final ActivityType type;
        private final double impact;
        private final long timestamp;

        public CommunityActivity(String userId, ActivityType type, double impact, long timestamp) {
            this.userId = userId;
            this.type = type;
            this.impact = impact;
            this.timestamp = timestamp;
        }
    }

    /**
     * أنواع الأنشطة
     */
    public enum ActivityType {
        TRADING, AD_CAMPAIGN, REFERRAL, ACHIEVEMENT, SOCIAL_POST
    }
}