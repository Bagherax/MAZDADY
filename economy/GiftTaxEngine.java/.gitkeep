package mazdady.economy;

import mazdady.user.User;
import mazdady.user.UserManager;
import mazdady.admin.AdminConfig;
import mazdady.trading.PriceEngine;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.atomic.AtomicReference;

/**
 * Ù…Ø­Ø±Ùƒ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Strategy Ù„ÙØµÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
 */
public final class GiftTaxEngine {
    private final PriceEngine priceEngine;
    private final AtomicReference<Double> giftTaxRate = new AtomicReference<>(0.3); // 30% Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    private static GiftTaxEngine instance;

    private GiftTaxEngine(PriceEngine priceEngine) {
        this.priceEngine = priceEngine;
        loadGiftTaxRateFromConfig();
    }

    public static synchronized GiftTaxEngine getInstance(PriceEngine priceEngine) {
        if (instance == null) {
            instance = new GiftTaxEngine(priceEngine);
        }
        return instance;
    }

    private void loadGiftTaxRateFromConfig() {
        try {
            AdminConfig.EconomyConfig economyConfig = 
                AdminConfig.getInstance().getEconomyConfig();
            
            if (economyConfig != null) {
                double rate = economyConfig.getGiftTaxRate();
                giftTaxRate.set(rate);
                System.out.println("GIFT TAX ENGINE: Loaded gift tax rate - " + 
                                 String.format("%.1f", rate * 100) + "%");
            }
            
        } catch (Exception e) {
            System.err.println("GIFT TAX CONFIG ERROR: " + e.getMessage());
        }
    }

    /**
     * ØªØ·Ø¨ÙŠÙ‚ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<GiftTaxResult> applyGiftTaxAsync(
        String userId, 
        double profitAmount
    ) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                if (profitAmount <= 0) {
                    return GiftTaxResult.failure("Invalid profit amount");
                }
                
                User user = UserManager.getInstance(null).getUserById(userId);
                if (user == null) {
                    return GiftTaxResult.failure("User not found");
                }
                
                double taxRate = giftTaxRate.get();
                double taxAmount = profitAmount * taxRate;
                double netProfit = profitAmount - taxAmount;
                
                // ØªØ­ÙˆÙŠÙ„ "Ø§Ù„Ù‡Ø¯ÙŠØ©" Ø¥Ù„Ù‰ Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
                priceEngine.addToSystemTreasury(taxAmount);
                
                // Ù…Ù†Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‚Ø§Ø· Ù…Ø¬ØªÙ…Ø¹ÙŠØ©
                user.addCommunityPoints((int) taxAmount);
                
                // Ø¹Ø±Ø¶ ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
                showGiftEffect(taxAmount);
                
                System.out.println("GIFT TAX ENGINE: Applied gift tax - Profit: " + 
                                 String.format("%.2f", profitAmount) + 
                                 " MAZDADY - Tax: " + String.format("%.2f", taxAmount) + 
                                 " MAZDADY - Net: " + String.format("%.2f", netProfit) + " MAZDADY");
                
                return GiftTaxResult.success(
                    profitAmount, 
                    taxAmount, 
                    netProfit, 
                    "Gift tax applied successfully"
                );
                
            } catch (Exception e) {
                return GiftTaxResult.failure("Gift tax application failed: " + e.getMessage());
            }
        });
    }

    private void showGiftEffect(double taxAmount) {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¹Ø±Ø¶ ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        System.out.println("ğŸ GIFT TAX EFFECT: +" + String.format("%.2f", taxAmount) + 
                         " MAZDADY community contribution");
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø¯Ù„ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
     */
    public void updateGiftTaxRate(double newRate) {
        if (newRate >= 0 && newRate <= 1.0) {
            giftTaxRate.set(newRate);
            System.out.println("GIFT TAX ENGINE: Updated gift tax rate to " + 
                             String.format("%.1f", newRate * 100) + "%");
        }
    }

    /**
     * Ø­Ø³Ø§Ø¨ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
     */
    public double calculateGiftTax(double profitAmount) {
        if (profitAmount <= 0) return 0;
        return profitAmount * giftTaxRate.get();
    }

    /**
     * Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
     */
    public double calculateNetProfit(double profitAmount) {
        if (profitAmount <= 0) return 0;
        double tax = calculateGiftTax(profitAmount);
        return profitAmount - tax;
    }

    // --- Ù†ØªÙŠØ¬Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ---
    public static final class GiftTaxResult {
        private final boolean success;
        private final double grossProfit;
        private final double taxAmount;
        private final double netProfit;
        private final String message;

        private GiftTaxResult(boolean success, double grossProfit, double taxAmount, 
                           double netProfit, String message) {
            this.success = success;
            this.grossProfit = grossProfit;
            this.taxAmount = taxAmount;
            this.netProfit = netProfit;
            this.message = message;
        }

        public static GiftTaxResult success(double grossProfit, double taxAmount, 
                                         double netProfit, String message) {
            return new GiftTaxResult(true, grossProfit, taxAmount, netProfit, message);
        }

        public static GiftTaxResult failure(String message) {
            return new GiftTaxResult(false, 0, 0, 0, message);
        }

        public boolean isSuccess() { return success; }
        public double getGrossProfit() { return grossProfit; }
        public double getTaxAmount() { return taxAmount; }
        public double getNetProfit() { return netProfit; }
        public String getMessage() { return message; }
    }

    // --- Getters ---
    public double getGiftTaxRate() { return giftTaxRate.get(); }
    public String getFormattedGiftTaxRate() { 
        return String.format("%.1f", giftTaxRate.get() * 100) + "%"; 
    }
    
    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void resetGiftTaxRate() {
        giftTaxRate.set(0.3); // 30% Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
        System.out.println("GIFT TAX ENGINE: Reset to default rate");
    }
}