package mazdady.emergency;

import mazdady.user.User;
import mazdady.user.UserManager;
import mazdady.wallet.WalletManager;
import mazdady.admin.AdminConfig;
import mazdady.security.SecurityMonitor;

import java.time.Instant;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;

/**
 * Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Facade Ù„ØªÙˆÙÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©
 */
public final class FailSafeMgr {
    private final WalletManager walletManager;
    private final SecurityMonitor securityMonitor;
    private final ScheduledExecutorService failSafeScheduler = Executors.newScheduledThreadPool(1);
    private final Map<String, Consumer<FailSafeEvent>> failSafeListeners = new ConcurrentHashMap<>();
    private volatile boolean failSafeModeActive = false;
    private static FailSafeMgr instance;

    private FailSafeMgr(WalletManager walletManager, SecurityMonitor securityMonitor) {
        this.walletManager = walletManager;
        this.securityMonitor = securityMonitor;
        startFailSafeMonitoring();
    }

    public static synchronized FailSafeMgr getInstance(WalletManager walletManager, SecurityMonitor securityMonitor) {
        if (instance == null) {
            instance = new FailSafeMgr(walletManager, securityMonitor);
        }
        return instance;
    }

    private void startFailSafeMonitoring() {
        failSafeScheduler.scheduleAtFixedRate(
            this::checkFailSafeConditions,
            0,
            10,
            TimeUnit.SECONDS
        );
        
        System.out.println("FAIL SAFE MGR: Started monitoring every 10 seconds");
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    private void checkFailSafeConditions() {
        try {
            if (failSafeModeActive) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù…Ø§Ù†
            if (shouldActivateFailSafe()) {
                activateFailSafe();
            }
            
        } catch (Exception e) {
            System.err.println("FAIL SAFE MONITORING ERROR: " + e.getMessage());
        }
    }

    private boolean shouldActivateFailSafe() {
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
            if (walletManager.getSystemTreasury() < 500.0) {
                return true;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            int userCount = UserManager.getInstance(null).getUserCount();
            if (userCount < 5) {
                return true;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø§Ù†
            if (securityMonitor.isCompromised()) {
                return true;
            }
            
            return false;
            
        } catch (Exception e) {
            System.err.println("FAIL SAFE CONDITION CHECK ERROR: " + e.getMessage());
            return false;
        }
    }

    /**
     * ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<FailSafeResult> activateFailSafeAsync() {
        return CompletableFuture.supplyAsync(() -> {
            try {
                activateFailSafe();
                return FailSafeResult.success("Fail safe activated successfully");
                
            } catch (Exception e) {
                return FailSafeResult.failure("Fail safe activation failed: " + e.getMessage());
            }
        });
    }

    /**
     * ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
     */
    public void activateFailSafe() {
        if (failSafeModeActive) {
            System.out.println("FAIL SAFE MGR: Fail safe already active");
            return;
        }
        
        failSafeModeActive = true;
        System.out.println("ğŸ›¡ï¸ FAIL SAFE MGR: Fail safe activated at " + Instant.now());
        
        // ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
        executeFailSafeMeasures();
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙˆØ±ÙŠØ©
        createEmergencyBackup();
        
        // Ø¬Ø¯ÙˆÙ„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 12 Ø³Ø§Ø¹Ø©
        failSafeScheduler.schedule(
            this::deactivateFailSafe,
            12,
            TimeUnit.HOURS
        );
    }

    /**
     * ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<FailSafeResult> deactivateFailSafeAsync() {
        return CompletableFuture.supplyAsync(() -> {
            try {
                deactivateFailSafe();
                return FailSafeResult.success("Fail safe deactivated successfully");
                
            } catch (Exception e) {
                return FailSafeResult.failure("Fail safe deactivation failed: " + e.getMessage());
            }
        });
    }

    /**
     * ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
     */
    public void deactivateFailSafe() {
        if (!failSafeModeActive) {
            System.out.println("FAIL SAFE MGR: Fail safe already inactive");
            return;
        }
        
        failSafeModeActive = false;
        System.out.println("âœ… FAIL SAFE MGR: Fail safe deactivated at " + Instant.now());
        
        // ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø£Ù…Ø§Ù†
        executeFailSafeExitMeasures();
    }

    private void executeFailSafeMeasures() {
        try {
            // 1. ØªØ¬Ù…ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            walletManager.freezeAllOperations();
            
            // 2. ØªØ¹Ø·ÙŠÙ„ Ø¨ÙˆØªØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            mazdady.bot.BotManager.getInstance(mazdady.trading.PriceEngine.getInstance())
                .stopAllBotsAsync();
            
            // 3. ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
            AdminConfig.getInstance().setReadOnlyMode(true);
            
            // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ
            securityMonitor.logSecurityEvent("FAIL_SAFE_ACTIVATED", 
                "Fail safe mode activated due to critical conditions");
            
            System.out.println("FAIL SAFE MGR: Fail safe measures executed");
            
        } catch (Exception e) {
            System.err.println("FAIL SAFE MEASURES ERROR: " + e.getMessage());
        }
    }

    private void executeFailSafeExitMeasures() {
        try {
            // 1. Ø¥Ù„ØºØ§Ø¡ ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            walletManager.unfreezeAllOperations();
            
            // 2. Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØªØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            mazdady.bot.BotManager.getInstance(mazdady.trading.PriceEngine.getInstance())
                .startAllBots();
            
            // 3. Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
            AdminConfig.getInstance().setReadOnlyMode(false);
            
            // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ
            securityMonitor.logSecurityEvent("FAIL_SAFE_DEACTIVATED", 
                "Fail safe mode deactivated - System stabilized");
            
            System.out.println("FAIL SAFE MGR: Fail safe exit measures executed");
            
        } catch (Exception e) {
            System.err.println("FAIL SAFE EXIT MEASURES ERROR: " + e.getMessage());
        }
    }

    private void createEmergencyBackup() {
        try {
            // 1. Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            String userBackup = UserManager.getInstance(null).exportUserData();
            securityMonitor.getSecureStorage().putString("emergency_user_backup", 
                securityMonitor.getSecureStorage().encrypt(userBackup));
            
            // 2. Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
            String walletBackup = walletManager.exportWalletData();
            securityMonitor.getSecureStorage().putString("emergency_wallet_backup", 
                securityMonitor.getSecureStorage().encrypt(walletBackup));
            
            // 3. Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            String configBackup = AdminConfig.getInstance().exportConfig();
            securityMonitor.getSecureStorage().putString("emergency_config_backup", 
                securityMonitor.getSecureStorage().encrypt(configBackup));
            
            System.out.println("FAIL SAFE MGR: Emergency backup created");
            
        } catch (Exception e) {
            System.err.println("EMERGENCY BACKUP ERROR: " + e.getMessage());
        }
    }

    /**
     * Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<RecoveryResult> recoverFromBackupAsync() {
        return CompletableFuture.supplyAsync(() -> {
            try {
                // 1. Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                String userBackup = securityMonitor.getSecureStorage().getString("emergency_user_backup", null);
                if (userBackup != null) {
                    String decryptedUserBackup = securityMonitor.getSecureStorage().decrypt(userBackup);
                    UserManager.getInstance(null).importUserData(decryptedUserBackup);
                }
                
                // 2. Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
                String walletBackup = securityMonitor.getSecureStorage().getString("emergency_wallet_backup", null);
                if (walletBackup != null) {
                    String decryptedWalletBackup = securityMonitor.getSecureStorage().decrypt(walletBackup);
                    walletManager.importWalletData(decryptedWalletBackup);
                }
                
                // 3. Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                String configBackup = securityMonitor.getSecureStorage().getString("emergency_config_backup", null);
                if (configBackup != null) {
                    String decryptedConfigBackup = securityMonitor.getSecureStorage().decrypt(configBackup);
                    AdminConfig.getInstance().importConfig(decryptedConfigBackup);
                }
                
                System.out.println("FAIL SAFE MGR: System recovered from emergency backup");
                return RecoveryResult.success("System recovered successfully from backup");
                
            } catch (Exception e) {
                return RecoveryResult.failure("Recovery from backup failed: " + e.getMessage());
            }
        });
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
     */
    public void addFailSafeListener(String listenerId, Consumer<FailSafeEvent> listener) {
        if (listenerId != null && listener != null) {
            failSafeListeners.put(listenerId, listener);
            System.out.println("FAIL SAFE MGR: Added fail safe listener - " + listenerId);
        }
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
     */
    public void removeFailSafeListener(String listenerId) {
        failSafeListeners.remove(listenerId);
        System.out.println("FAIL SAFE MGR: Removed fail safe listener - " + listenerId);
    }

    private void notifyFailSafeListeners(FailSafeEvent event) {
        failSafeListeners.values().forEach(listener -> {
            try {
                listener.accept(event);
            } catch (Exception e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
            }
        });
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
     */
    public void updateFailSafeConfig(AdminConfig.FailSafeConfig config) {
        if (config != null) {
            System.out.println("FAIL SAFE MGR: Updated fail safe config from admin");
        }
    }

    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¯ÙŠØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        failSafeScheduler.shutdown();
        failSafeListeners.clear();
        System.out.println("FAIL SAFE MGR: Shutdown completed");
    }

    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯ÙŠØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void reset() {
        failSafeModeActive = false;
        failSafeListeners.clear();
        System.out.println("FAIL SAFE MGR: Reset completed");
    }

    /**
     * Ø­Ø¯Ø« Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
     */
    public static final class FailSafeEvent {
        private final FailSafeEventType type;
        private final String message;
        private final Instant timestamp;

        public FailSafeEvent(FailSafeEventType type, String message, Instant timestamp) {
            this.type = type;
            this.message = message;
            this.timestamp = timestamp;
        }

        public enum FailSafeEventType {
            ACTIVATED, DEACTIVATED, BACKUP_CREATED, RECOVERY_COMPLETED, SYSTEM_STABILIZED
        }

        // Getters
        public FailSafeEventType getType() { return type; }
        public String getMessage() { return message; }
        public Instant getTimestamp() { return timestamp; }
        
        @Override
        public String toString() {
            return "FailSafeEvent{" +
                "type=" + type +
                ", message='" + message + '\'' +
                ", timestamp=" + timestamp +
                '}';
        }
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
     */
    public static final class FailSafeResult {
        private final boolean success;
        private final String message;

        private FailSafeResult(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public static FailSafeResult success(String message) {
            return new FailSafeResult(true, message);
        }

        public static FailSafeResult failure(String message) {
            return new FailSafeResult(false, message);
        }

        public boolean isSuccess() { return success; }
        public String getMessage() { return message; }
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
     */
    public static final class RecoveryResult {
        private final boolean success;
        private final String message;

        private RecoveryResult(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public static RecoveryResult success(String message) {
            return new RecoveryResult(true, message);
        }

        public static RecoveryResult failure(String message) {
            return new RecoveryResult(false, message);
        }

        public boolean isSuccess() { return success; }
        public String getMessage() { return message; }
    }

    // --- Getters ---
    public boolean isFailSafeModeActive() { return failSafeModeActive; }
    public int getFailSafeListenerCount() { return failSafeListeners.size(); }
    public boolean hasFailSafeListeners() { return !failSafeListeners.isEmpty(); }
    public Map<String, Consumer<FailSafeEvent>> getFailSafeListeners() { 
        return new ConcurrentHashMap<>(failSafeListeners); 
    }
}