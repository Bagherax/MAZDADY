package mazdady.emergency;

import mazdady.user.User;
import mazdady.user.UserManager;
import mazdady.wallet.WalletManager;
import mazdady.admin.AdminConfig;
import mazdady.security.SecurityMonitor;

import java.time.Instant;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;

/**
 * Ù…Ø¯ÙŠØ± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Facade Ù„ØªÙˆÙÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©
 */
public final class EmergencyMgr {
    private final WalletManager walletManager;
    private final SecurityMonitor securityMonitor;
    private final ScheduledExecutorService emergencyScheduler = Executors.newScheduledThreadPool(1);
    private final Map<String, Consumer<EmergencyEvent>> emergencyListeners = new ConcurrentHashMap<>();
    private volatile boolean emergencyModeActive = false;
    private static EmergencyMgr instance;

    private EmergencyMgr(WalletManager walletManager, SecurityMonitor securityMonitor) {
        this.walletManager = walletManager;
        this.securityMonitor = securityMonitor;
        startEmergencyMonitoring();
    }

    public static synchronized EmergencyMgr getInstance(WalletManager walletManager, SecurityMonitor securityMonitor) {
        if (instance == null) {
            instance = new EmergencyMgr(walletManager, securityMonitor);
        }
        return instance;
    }

    private void startEmergencyMonitoring() {
        emergencyScheduler.scheduleAtFixedRate(
            this::checkForEmergencies,
            0,
            30,
            TimeUnit.SECONDS
        );
        
        System.out.println("EMERGENCY MGR: Started monitoring every 30 seconds");
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø²Ù…Ø§Øª ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    private void checkForEmergencies() {
        try {
            if (emergencyModeActive) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
            checkWalletEmergency();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø§Ù†
            checkSecurityEmergency();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            checkSystemEmergency();
            
        } catch (Exception e) {
            System.err.println("EMERGENCY CHECK ERROR: " + e.getMessage());
        }
    }

    private void checkWalletEmergency() {
        try {
            double systemTreasury = walletManager.getSystemTreasury();
            double totalUserBalance = UserManager.getInstance(null).getAllUsers().stream()
                .mapToDouble(User::getBalance)
                .sum();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø²Ø§Ù† Ø£Ù‚Ù„ Ù…Ù† 10% Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            if (systemTreasury < totalUserBalance * 0.1) {
                triggerEmergency(EmergencyType.WALLET_CRISIS, "System treasury below 10% of user balances");
            }
            
        } catch (Exception e) {
            System.err.println("WALLET EMERGENCY CHECK ERROR: " + e.getMessage());
        }
    }

    private void checkSecurityEmergency() {
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©
            int failedAttempts = securityMonitor.getFailedLoginAttempts();
            if (failedAttempts > 100) {
                triggerEmergency(EmergencyType.SECURITY_CRISIS, "High number of failed login attempts detected");
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø®ØªØ±Ù‚Ø©
            int compromisedDevices = securityMonitor.getCompromisedDevicesCount();
            if (compromisedDevices > 10) {
                triggerEmergency(EmergencyType.SECURITY_CRISIS, "Multiple compromised devices detected");
            }
            
        } catch (Exception e) {
            System.err.println("SECURITY EMERGENCY CHECK ERROR: " + e.getMessage());
        }
    }

    private void checkSystemEmergency() {
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
            double cpuUsage = getSystemCPUUsage();
            double memoryUsage = getSystemMemoryUsage();
            
            if (cpuUsage > 90.0 || memoryUsage > 95.0) {
                triggerEmergency(EmergencyType.SYSTEM_CRISIS, 
                    "High system resource usage - CPU: " + String.format("%.1f", cpuUsage) + 
                    "%, Memory: " + String.format("%.1f", memoryUsage) + "%");
            }
            
        } catch (Exception e) {
            System.err.println("SYSTEM EMERGENCY CHECK ERROR: " + e.getMessage());
        }
    }

    /**
     * ØªÙØ¹ÙŠÙ„ Ø£Ø²Ù…Ø© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<EmergencyResult> triggerEmergencyAsync(EmergencyType emergencyType, String reason) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                triggerEmergency(emergencyType, reason);
                return EmergencyResult.success("Emergency triggered successfully");
                
            } catch (Exception e) {
                return EmergencyResult.failure("Emergency trigger failed: " + e.getMessage());
            }
        });
    }

    private void triggerEmergency(EmergencyType emergencyType, String reason) {
        System.out.println("ğŸš¨ EMERGENCY MGR: Emergency triggered - " + emergencyType + " - " + reason);
        
        EmergencyEvent event = new EmergencyEvent(emergencyType, reason, Instant.now());
        notifyEmergencyListeners(event);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø²Ù…Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ
        securityMonitor.reportEmergency(emergencyType.name(), reason);
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
        applyEmergencyMeasures(emergencyType, reason);
    }

    private void applyEmergencyMeasures(EmergencyType emergencyType, String reason) {
        switch (emergencyType) {
            case WALLET_CRISIS:
                handleWalletCrisis(reason);
                break;
            case SECURITY_CRISIS:
                handleSecurityCrisis(reason);
                break;
            case SYSTEM_CRISIS:
                handleSystemCrisis(reason);
                break;
            case FINANCIAL_CRISIS:
                handleFinancialCrisis(reason);
                break;
        }
    }

    private void handleWalletCrisis(String reason) {
        System.out.println("WALLET CRISIS: Applying protective measures...");
        
        // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§
        walletManager.freezeWithdrawals(60); // ØªØ¬Ù…ÙŠØ¯ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø©
        
        // ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
        FailSafeMgr.getInstance(walletManager, securityMonitor).activateEmergencyMode();
        
        // Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø§Ø¯Ù…Ù†
        AdminConfig.getInstance().notifyAdmins("WALLET_CRISIS", reason);
    }

    private void handleSecurityCrisis(String reason) {
        System.out.println("SECURITY CRISIS: Activating security protocols...");
        
        // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¹Ø§Ù„ÙŠ
        securityMonitor.activateHighSecurityMode();
        
        // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        UserManager.getInstance(null).logoutAllUsers();
        
        // Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø§Ø¯Ù…Ù†
        AdminConfig.getInstance().notifyAdmins("SECURITY_CRISIS", reason);
    }

    private void handleSystemCrisis(String reason) {
        System.out.println("SYSTEM CRISIS: Optimizing system resources...");
        
        // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©
        reduceBackgroundProcesses();
        
        // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„ÙŠ
        activateHighPerformanceMode();
        
        // Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø§Ø¯Ù…Ù†
        AdminConfig.getInstance().notifyAdmins("SYSTEM_CRISIS", reason);
    }

    private void handleFinancialCrisis(String reason) {
        System.out.println("FINANCIAL CRISIS: Stabilizing financial system...");
        
        // ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØª ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³ÙˆÙ‚
        mazdady.bot.MarketStabilizerBot stabilizerBot = 
            new mazdady.bot.MarketStabilizerBot("STAB_BOT_" + System.currentTimeMillis(), 
                                              mazdady.trading.PriceEngine.getInstance());
        stabilizerBot.start();
        
        // Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø§Ø¯Ù…Ù†
        AdminConfig.getInstance().notifyAdmins("FINANCIAL_CRISIS", reason);
    }

    private void reduceBackgroundProcesses() {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©
        System.out.println("EMERGENCY MGR: Reduced background processes");
    }

    private void activateHighPerformanceMode() {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„ÙŠ
        System.out.println("EMERGENCY MGR: Activated high performance mode");
    }

    private double getSystemCPUUsage() {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† SystemInfo
        return ThreadLocalRandom.current().nextDouble(0, 100);
    }

    private double getSystemMemoryUsage() {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† Runtime
        Runtime runtime = Runtime.getRuntime();
        long maxMemory = runtime.maxMemory();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        long usedMemory = totalMemory - freeMemory;
        return (double) usedMemory / maxMemory * 100;
    }

    private void notifyEmergencyListeners(EmergencyEvent event) {
        emergencyListeners.values().forEach(listener -> {
            try {
                listener.accept(event);
            } catch (Exception e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
            }
        });
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø²Ù…Ø§Øª
     */
    public void addEmergencyListener(String listenerId, Consumer<EmergencyEvent> listener) {
        if (listenerId != null && listener != null) {
            emergencyListeners.put(listenerId, listener);
            System.out.println("EMERGENCY MGR: Added emergency listener - " + listenerId);
        }
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø²Ù…Ø§Øª
     */
    public void removeEmergencyListener(String listenerId) {
        emergencyListeners.remove(listenerId);
        System.out.println("EMERGENCY MGR: Removed emergency listener - " + listenerId);
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
     */
    public void updateEmergencyConfig(AdminConfig.EmergencyConfig config) {
        if (config != null) {
            System.out.println("EMERGENCY MGR: Updated emergency config from admin");
        }
    }

    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¯ÙŠØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        emergencyScheduler.shutdown();
        emergencyListeners.clear();
        System.out.println("EMERGENCY MGR: Shutdown completed");
    }

    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯ÙŠØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void reset() {
        emergencyModeActive = false;
        emergencyListeners.clear();
        System.out.println("EMERGENCY MGR: Reset completed");
    }

    /**
     * Ø­Ø¯Ø« Ø§Ù„Ø£Ø²Ù…Ø©
     */
    public static final class EmergencyEvent {
        private final EmergencyType type;
        private final String reason;
        private final Instant timestamp;

        public EmergencyEvent(EmergencyType type, String reason, Instant timestamp) {
            this.type = type;
            this.reason = reason;
            this.timestamp = timestamp;
        }

        public enum EmergencyType {
            WALLET_CRISIS, SECURITY_CRISIS, SYSTEM_CRISIS, FINANCIAL_CRISIS
        }

        // Getters
        public EmergencyType getType() { return type; }
        public String getReason() { return reason; }
        public Instant getTimestamp() { return timestamp; }
        
        @Override
        public String toString() {
            return "EmergencyEvent{" +
                "type=" + type +
                ", reason='" + reason + '\'' +
                ", timestamp=" + timestamp +
                '}';
        }
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø²Ù…Ø©
     */
    public static final class EmergencyResult {
        private final boolean success;
        private final String message;

        private EmergencyResult(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public static EmergencyResult success(String message) {
            return new EmergencyResult(true, message);
        }

        public static EmergencyResult failure(String message) {
            return new EmergencyResult(false, message);
        }

        public boolean isSuccess() { return success; }
        public String getMessage() { return message; }
    }

    // --- Getters ---
    public boolean isEmergencyModeActive() { return emergencyModeActive; }
    public int getEmergencyListenerCount() { return emergencyListeners.size(); }
    public boolean hasEmergencyListeners() { return !emergencyListeners.isEmpty(); }
    public Map<String, Consumer<EmergencyEvent>> getEmergencyListeners() { 
        return new ConcurrentHashMap<>(emergencyListeners); 
    }
}