package mazdady.emergency;

import mazdady.user.User;
import mazdady.user.UserManager;
import mazdady.wallet.WalletManager;
import mazdady.admin.AdminConfig;
import mazdady.security.SecurityMonitor;

import java.time.Instant;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;

/**
 * Ù…Ø¯ÙŠØ± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Facade Ù„ØªÙˆÙÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©
 */
public final class EmergencyMgr {
    private final WalletManager walletManager;
    private final SecurityMonitor securityMonitor;
    private final ScheduledExecutorService emergencyScheduler = Executors.newScheduledThreadPool(1);
    private final Map<String, Consumer<EmergencyEvent>> emergencyListeners = new ConcurrentHashMap<>();
    private volatile boolean emergencyModeActive = false;
    private volatile EmergencyLevel currentLevel = EmergencyLevel.NORMAL;
    private static EmergencyMgr instance;

    private EmergencyMgr(WalletManager walletManager, SecurityMonitor securityMonitor) {
        this.walletManager = walletManager;
        this.securityMonitor = securityMonitor;
        startEmergencyMonitoring();
    }

    public static synchronized EmergencyMgr getInstance(WalletManager walletManager, SecurityMonitor securityMonitor) {
        if (instance == null) {
            instance = new EmergencyMgr(walletManager, securityMonitor);
        }
        return instance;
    }

    private void startEmergencyMonitoring() {
        emergencyScheduler.scheduleAtFixedRate(
            this::checkEmergencyConditions,
            0,
            15,
            TimeUnit.SECONDS
        );
        
        System.out.println("EMERGENCY MANAGER: Started emergency monitoring every 15 seconds");
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±ÙˆØ· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    private void checkEmergencyConditions() {
        try {
            if (emergencyModeActive) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±ÙˆØ· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
            if (shouldActivateEmergencyMode()) {
                activateEmergencyMode();
            }
            
        } catch (Exception e) {
            System.err.println("EMERGENCY MONITORING ERROR: " + e.getMessage());
        }
    }

    private boolean shouldActivateEmergencyMode() {
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¸Ø§Ù…
            double systemTreasury = walletManager.getSystemTreasury();
            if (systemTreasury < 1000.0) { // Ø£Ù‚Ù„ Ù…Ù† 1000 MAZDADY
                return true;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
            int activeUsers = UserManager.getInstance(null).getActiveUserCount();
            if (activeUsers < 10) { // Ø£Ù‚Ù„ Ù…Ù† 10 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†
                return true;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø§Ù†
            if (securityMonitor.hasRecentSecurityIncidents()) {
                return true;
            }
            
            return false;
            
        } catch (Exception e) {
            System.err.println("EMERGENCY CONDITION CHECK ERROR: " + e.getMessage());
            return false;
        }
    }

    /**
     * ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<EmergencyResult> activateEmergencyModeAsync() {
        return CompletableFuture.supplyAsync(() -> {
            try {
                activateEmergencyMode();
                return EmergencyResult.success("Emergency mode activated successfully");
                
            } catch (Exception e) {
                return EmergencyResult.failure("Emergency mode activation failed: " + e.getMessage());
            }
        });
    }

    /**
     * ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public void activateEmergencyMode() {
        if (emergencyModeActive) {
            System.out.println("EMERGENCY MANAGER: Emergency mode already active");
            return;
        }
        
        emergencyModeActive = true;
        currentLevel = EmergencyLevel.CRITICAL;
        
        System.out.println("ğŸš¨ EMERGENCY MANAGER: Emergency mode activated at " + Instant.now());
        
        // ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
        executeEmergencyMeasures();
        
        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
        notifyEmergencyListeners(new EmergencyEvent(
            EmergencyEventType.MODE_ACTIVATED,
            "Emergency mode activated",
            Instant.now()
        ));
        
        // Ø¬Ø¯ÙˆÙ„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©
        emergencyScheduler.schedule(
            this::deactivateEmergencyMode,
            24,
            TimeUnit.HOURS
        );
    }

    /**
     * ØªØ¹Ø·ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<EmergencyResult> deactivateEmergencyModeAsync() {
        return CompletableFuture.supplyAsync(() -> {
            try {
                deactivateEmergencyMode();
                return EmergencyResult.success("Emergency mode deactivated successfully");
                
            } catch (Exception e) {
                return EmergencyResult.failure("Emergency mode deactivation failed: " + e.getMessage());
            }
        });
    }

    /**
     * ØªØ¹Ø·ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public void deactivateEmergencyMode() {
        if (!emergencyModeActive) {
            System.out.println("EMERGENCY MANAGER: Emergency mode already inactive");
            return;
        }
        
        emergencyModeActive = false;
        currentLevel = EmergencyLevel.NORMAL;
        
        System.out.println("âœ… EMERGENCY MANAGER: Emergency mode deactivated at " + Instant.now());
        
        // ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
        executeEmergencyExitMeasures();
        
        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
        notifyEmergencyListeners(new EmergencyEvent(
            EmergencyEventType.MODE_DEACTIVATED,
            "Emergency mode deactivated",
            Instant.now()
        ));
    }

    private void executeEmergencyMeasures() {
        try {
            // 1. ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
            walletManager.freezeWithdrawals(1440); // ØªØ¬Ù…ÙŠØ¯ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø©
            
            // 2. ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
            mazdady.bot.EmergencyBot emergencyBot = 
                mazdady.bot.EmergencyBot.getInstance(
                    mazdady.trading.PriceEngine.getInstance(),
                    new mazdady.ui.TradingLineView(null, null)
                );
            emergencyBot.activateEmergencyBot();
            
            // 3. Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¬Ù…ÙŠØ¹
            UserManager.getInstance(null).getAllUsers().forEach(user -> {
                System.out.println("EMERGENCY ALERT: Sent to user " + user.getUserId());
            });
            
            // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ
            securityMonitor.logEmergencyEvent("EMERGENCY_MODE_ACTIVATED", 
                "Emergency mode activated due to critical system conditions");
            
            System.out.println("EMERGENCY MANAGER: Emergency measures executed");
            
        } catch (Exception e) {
            System.err.println("EMERGENCY MEASURES ERROR: " + e.getMessage());
        }
    }

    private void executeEmergencyExitMeasures() {
        try {
            // 1. Ø¥Ù„ØºØ§Ø¡ ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
            walletManager.unfreezeWithdrawals();
            
            // 2. ØªØ¹Ø·ÙŠÙ„ Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
            mazdady.bot.EmergencyBot emergencyBot = 
                mazdady.bot.EmergencyBot.getInstance(
                    mazdady.trading.PriceEngine.getInstance(),
                    new mazdady.ui.TradingLineView(null, null)
                );
            emergencyBot.deactivateEmergencyBot();
            
            // 3. Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
            UserManager.getInstance(null).getAllUsers().forEach(user -> {
                System.out.println("EMERGENCY EXIT ALERT: Sent to user " + user.getUserId());
            });
            
            // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ
            securityMonitor.logEmergencyEvent("EMERGENCY_MODE_DEACTIVATED", 
                "Emergency mode deactivated - System stabilized");
            
            System.out.println("EMERGENCY MANAGER: Emergency exit measures executed");
            
        } catch (Exception e) {
            System.err.println("EMERGENCY EXIT MEASURES ERROR: " + e.getMessage());
        }
    }

    private void notifyEmergencyListeners(EmergencyEvent event) {
        emergencyListeners.values().forEach(listener -> {
            try {
                listener.accept(event);
            } catch (Exception e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
            }
        });
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public void addEmergencyListener(String listenerId, Consumer<EmergencyEvent> listener) {
        if (listenerId != null && listener != null) {
            emergencyListeners.put(listenerId, listener);
            System.out.println("EMERGENCY MANAGER: Added emergency listener - " + listenerId);
        }
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public void removeEmergencyListener(String listenerId) {
        if (listenerId != null) {
            emergencyListeners.remove(listenerId);
            System.out.println("EMERGENCY MANAGER: Removed emergency listener - " + listenerId);
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public void updateEmergencyLevel(EmergencyLevel level) {
        this.currentLevel = level;
        System.out.println("EMERGENCY MANAGER: Emergency level updated to " + level);
        
        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
        notifyEmergencyListeners(new EmergencyEvent(
            EmergencyEventType.LEVEL_CHANGED,
            "Emergency level changed to " + level,
            Instant.now()
        ));
    }

    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¯ÙŠØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        emergencyScheduler.shutdown();
        emergencyListeners.clear();
        emergencyModeActive = false;
        System.out.println("EMERGENCY MANAGER: Shutdown completed");
    }

    /**
     * Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public enum EmergencyLevel {
        NORMAL, WARNING, CRITICAL, SYSTEM_WIDE
    }

    /**
     * Ø£Ù†ÙˆØ§Ø¹ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public enum EmergencyEventType {
        MODE_ACTIVATED, MODE_DEACTIVATED, LEVEL_CHANGED, SYSTEM_ALERT
    }

    /**
     * Ø­Ø¯Ø« Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public static final class EmergencyEvent {
        private final EmergencyEventType type;
        private final String message;
        private final Instant timestamp;

        public EmergencyEvent(EmergencyEventType type, String message, Instant timestamp) {
            this.type = type;
            this.message = message;
            this.timestamp = timestamp;
        }

        public EmergencyEventType getType() { return type; }
        public String getMessage() { return message; }
        public Instant getTimestamp() { return timestamp; }
        
        @Override
        public String toString() {
            return "EmergencyEvent{" +
                "type=" + type +
                ", message='" + message + '\'' +
                ", timestamp=" + timestamp +
                '}';
        }
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public static final class EmergencyResult {
        private final boolean success;
        private final String message;

        private EmergencyResult(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public static EmergencyResult success(String message) {
            return new EmergencyResult(true, message);
        }

        public static EmergencyResult failure(String message) {
            return new EmergencyResult(false, message);
        }

        public boolean isSuccess() { return success; }
        public String getMessage() { return message; }
    }

    // --- Getters ---
    public boolean isEmergencyModeActive() { return emergencyModeActive; }
    public EmergencyLevel getCurrentLevel() { return currentLevel; }
    public int getEmergencyListenerCount() { return emergencyListeners.size(); }
    public boolean hasActiveEmergency() { return emergencyModeActive && currentLevel != EmergencyLevel.NORMAL; }
    
    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void resetEmergencyState() {
        emergencyModeActive = false;
        currentLevel = EmergencyLevel.NORMAL;
        System.out.println("EMERGENCY MANAGER: Emergency state reset");
    }
}