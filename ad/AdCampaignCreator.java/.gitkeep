package mazdady.ad;

import mazdady.arch.BusinessInteractor;
import mazdady.user.UserManager;
import mazdady.wallet.WalletManager;

/**
 * منشئ الحملات كمنفذ للمنطق التجاري
 * يتبع نمط Template Method مع التحقق من الصلاحيات
 */
public final class AdCampaignCreator extends BusinessInteractor<AdCampaignCreator.Request, AdCampaign> {

    @Override
    protected boolean hasPermission(Request request) {
        return UserManager.getInstance(null).getCurrentUser().getUserId().equals(request.userId());
    }

    @Override
    protected AdCampaign performBusinessLogic(Request request) {
        // 1. التحقق من رصيد المستخدم
        WalletManager wallet = new WalletManager();
        if (wallet.getBalance() < request.budget()) {
            throw new IllegalStateException("Insufficient balance for campaign");
        }

        // 2. خصم الميزانية
        boolean withdrawn = wallet.withdrawMAZDADY(request.budget());
        if (!withdrawn) {
            throw new IllegalStateException("Failed to withdraw campaign budget");
        }

        // 3. إنشاء الحملة
        return new AdCampaign.Builder()
            .userId(request.userId())
            .platform(request.platform())
            .contentUrl(request.contentUrl())
            .goal(request.goal())
            .targetCount(request.targetCount())
            .budget(request.budget())
            .build();
    }

    /**
     * طلب إنشاء حملة (كائن غير قابل للتغيير)
     */
    public record Request(
        String userId,
        AdCampaign.Platform platform,
        String contentUrl,
        AdCampaign.Goal goal,
        int targetCount,
        double budget
    ) {}
}