package mazdady.trading;

import android.content.Context;
import android.graphics.Canvas;
import android.graphics.Color;
import android.graphics.Paint;
import android.util.AttributeSet;
import android.view.View;
import android.widget.ImageView;
import android.widget.LinearLayout;

import java.util.concurrent.CopyOnWriteArrayList;
import java.util.List;

/**
 * Ø¹Ø±Ø¶ Ø®Ø· Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Observer Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
 */
public final class TradingLineView extends LinearLayout {
    private final Paint linePaint = new Paint(Paint.ANTI_ALIAS_FLAG);
    private final Paint profitPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
    private final CopyOnWriteArrayList<TraderImage> traderImages = new CopyOnWriteArrayList<>();
    private final CopyOnWriteArrayList<ProfitIndicator> profitIndicators = new CopyOnWriteArrayList<>();
    private static TradingLineView instance;

    public TradingLineView(Context context, AttributeSet attrs) {
        super(context, attrs);
        initializePaints();
        setOrientation(HORIZONTAL);
        setWillNotDraw(false);
    }

    private void initializePaints() {
        linePaint.setColor(Color.parseColor("#4CAF50"));
        linePaint.setStrokeWidth(6f);
        linePaint.setStyle(Paint.Style.STROKE);
        
        profitPaint.setTextSize(14f);
        profitPaint.setFakeBoldText(true);
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø®Ø· Ø§Ù„ØªØ¯Ø§ÙˆÙ„
     */
    public void addTraderImage(String avatarUrl) {
        post(() -> {
            try {
                ImageView imageView = new ImageView(getContext());
                // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† avatarUrl
                imageView.setImageResource(android.R.drawable.ic_menu_gallery);
                imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);
                
                LayoutParams params = new LayoutParams(60, 60);
                params.setMargins(5, 0, 5, 0);
                imageView.setLayoutParams(params);
                
                addView(imageView);
                traderImages.add(new TraderImage(imageView, avatarUrl));
                
                System.out.println("TRADING LINE: Added trader image - " + avatarUrl);
                
            } catch (Exception e) {
                System.err.println("TRADING LINE ERROR: " + e.getMessage());
            }
        });
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø©
     */
    public void addProfitIndicator(String color, double profit) {
        post(() -> {
            try {
                ProfitIndicator indicator = new ProfitIndicator(color, profit);
                profitIndicators.add(indicator);
                invalidate(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶
                
                System.out.println("TRADING LINE: Added profit indicator - " + color + " " + profit);
                
            } catch (Exception e) {
                System.err.println("PROFIT INDICATOR ERROR: " + e.getMessage());
            }
        });
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© ØµÙˆØ±Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø®Ø· Ø§Ù„ØªØ¯Ø§ÙˆÙ„
     */
    public void removeTraderImage(String avatarUrl) {
        post(() -> {
            try {
                TraderImage traderImage = traderImages.stream()
                    .filter(img -> avatarUrl.equals(img.getAvatarUrl()))
                    .findFirst()
                    .orElse(null);
                
                if (traderImage != null) {
                    removeView(traderImage.getImageView());
                    traderImages.remove(traderImage);
                    System.out.println("TRADING LINE: Removed trader image - " + avatarUrl);
                }
                
            } catch (Exception e) {
                System.err.println("REMOVE TRADER IMAGE ERROR: " + e.getMessage());
            }
        });
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¨Ø­
     */
    public void removeProfitIndicator() {
        post(() -> {
            try {
                profitIndicators.clear();
                invalidate();
                System.out.println("TRADING LINE: Removed profit indicators");
            } catch (Exception e) {
                System.err.println("REMOVE PROFIT INDICATOR ERROR: " + e.getMessage());
            }
        });
    }

    @Override
    protected void onDraw(Canvas canvas) {
        super.onDraw(canvas);
        
        try {
            // Ø±Ø³Ù… Ø®Ø· Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            drawTradingLine(canvas);
            
            // Ø±Ø³Ù… Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©
            drawProfitIndicators(canvas);
            
        } catch (Exception e) {
            System.err.println("TRADING LINE DRAW ERROR: " + e.getMessage());
        }
    }

    private void drawTradingLine(Canvas canvas) {
        int width = getWidth();
        int height = getHeight();
        
        // Ø±Ø³Ù… Ø®Ø· Ø£ÙÙ‚ÙŠ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø±Ø¶
        canvas.drawLine(0, height / 2f, width, height / 2f, linePaint);
    }

    private void drawProfitIndicators(Canvas canvas) {
        int yOffset = 20;
        for (ProfitIndicator indicator : profitIndicators) {
            profitPaint.setColor(Color.parseColor(indicator.getColor()));
            String text = (indicator.getProfit() > 0 ? "ğŸ”º" : "ğŸ”»") + 
                         String.format("%.2f", Math.abs(indicator.getProfit()));
            canvas.drawText(text, 10, yOffset, profitPaint);
            yOffset += 30;
        }
    }

    /**
     * ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„
     */
    private static final class TraderImage {
        private final ImageView imageView;
        private final String avatarUrl;

        public TraderImage(ImageView imageView, String avatarUrl) {
            this.imageView = imageView;
            this.avatarUrl = avatarUrl;
        }

        public ImageView getImageView() { return imageView; }
        public String getAvatarUrl() { return avatarUrl; }
    }

    /**
     * Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¨Ø­
     */
    private static final class ProfitIndicator {
        private final String color;
        private final double profit;

        public ProfitIndicator(String color, double profit) {
            this.color = color;
            this.profit = profit;
        }

        public String getColor() { return color; }
        public double getProfit() { return profit; }
    }

    // --- Getters ---
    public int getTraderCount() { return traderImages.size(); }
    public int getProfitIndicatorCount() { return profitIndicators.size(); }
    public List<TraderImage> getTraderImages() { return traderImages; }
    public List<ProfitIndicator> getProfitIndicators() { return profitIndicators; }
    
    /**
     * Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void clearAll() {
        post(() -> {
            removeAllViews();
            traderImages.clear();
            profitIndicators.clear();
            System.out.println("TRADING LINE: Cleared all elements");
        });
    }
}
// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø¥Ù„Ù‰ TradingLineView.java

/**
 * Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø®Ø³Ø§Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
public void showLossIndicator(String userId, double amount, String lossType) {
    post(() -> {
        try {
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø®Ø³Ø§Ø±Ø© Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            addProfitIndicator("RED", -amount); // Ù…Ø¤Ø´Ø± Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø³Ø§Ø±Ø©
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            System.out.println("TRADING LINE: LOSS INDICATOR - User " + userId + 
                             " lost " + amount + " MAZDADY via " + lossType);
            
        } catch (Exception e) {
            System.err.println("LOSS INDICATOR ERROR: " + e.getMessage());
        }
    });
}