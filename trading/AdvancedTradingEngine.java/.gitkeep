package mazdady.trading;

import mazdady.user.User;
import mazdady.user.UserManager;
import mazdady.wallet.WalletManager;
import mazdady.bot.EmergencyBot;
import mazdady.admin.AdminConfig;

import java.time.Instant;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.TimeUnit;

/**
 * Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¥ÙÙ„Ø§Ø³
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Strategy Ù„ÙØµÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
 */
public final class AdvancedTradingEngine {
    private final PriceEngine priceEngine;
    private final WalletManager walletManager;
    private final EmergencyBot emergencyBot;
    private final ScheduledExecutorService tradeScheduler = Executors.newScheduledThreadPool(2);
    private static AdvancedTradingEngine instance;

    private AdvancedTradingEngine(
        PriceEngine priceEngine,
        WalletManager walletManager,
        EmergencyBot emergencyBot
    ) {
        this.priceEngine = priceEngine;
        this.walletManager = walletManager;
        this.emergencyBot = emergencyBot;
    }

    public static synchronized AdvancedTradingEngine getInstance(
        PriceEngine priceEngine,
        WalletManager walletManager,
        EmergencyBot emergencyBot
    ) {
        if (instance == null) {
            instance = new AdvancedTradingEngine(priceEngine, walletManager, emergencyBot);
        }
        return instance;
    }

    /**
     * ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙ‚Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø©
     */
    public CompletableFuture<TradeResult> executeAdvancedTradeAsync(
        String userId,
        double amount,
        TradeType tradeType,
        int tradeDurationSeconds
    ) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                User user = UserManager.getInstance(null).getCurrentUser();
                if (!user.getUserId().equals(userId)) {
                    return TradeResult.failure("Invalid user");
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø¨Ù„Øº
                if (amount < 0.01) { // Ø¯Ø¹Ù… MAZ Ø§Ù„ØµØºÙŠØ±Ø©
                    return TradeResult.failure("Minimum trade amount is 0.01 MAZDADY");
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
                if (user.getBalance() < amount) {
                    return TradeResult.failure("Insufficient balance");
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙØªØ±Ø© Ø§Ù„ØµÙÙ‚Ø©
                if (tradeDurationSeconds < 5 || tradeDurationSeconds > 24) {
                    return TradeResult.failure("Trade duration must be between 5 and 24 seconds");
                }
                
                // ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©
                return executeTrade(user, amount, tradeType, tradeDurationSeconds);
                
            } catch (Exception e) {
                return TradeResult.failure("Trade execution failed: " + e.getMessage());
            }
        });
    }

    private TradeResult executeTrade(User user, double amount, TradeType tradeType, int duration) {
        try {
            double initialPrice = priceEngine.getCurrentPrice();
            String tradeId = "trade_" + System.currentTimeMillis();
            
            System.out.println("ADVANCED TRADING: Trade started - " + tradeId + 
                             " - Amount: " + amount + " MAZDADY" +
                             " - Type: " + tradeType +
                             " - Duration: " + duration + " seconds");
            
            // Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµÙÙ‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            tradeScheduler.schedule(
                () -> completeTrade(tradeId, user, amount, tradeType, initialPrice),
                duration,
                TimeUnit.SECONDS
            );
            
            return TradeResult.pending(tradeId, "Trade in progress...");
            
        } catch (Exception e) {
            return TradeResult.failure("Trade initiation failed: " + e.getMessage());
        }
    }

    private void completeTrade(String tradeId, User user, double amount, TradeType tradeType, double initialPrice) {
        try {
            double finalPrice = priceEngine.getCurrentPrice();
            double priceChange = ((finalPrice - initialPrice) / initialPrice) * 100;
            
            boolean isProfit = (tradeType == TradeType.BUY && finalPrice > initialPrice) ||
                              (tradeType == TradeType.SELL && finalPrice < initialPrice);
            
            double profitLoss = 0;
            String resultMessage;
            
            if (isProfit) {
                // Ø±Ø¨Ø­
                profitLoss = amount * (Math.abs(priceChange) / 100);
                user.setBalance(user.getBalance() + profitLoss);
                resultMessage = "ğŸ‰ Profit: +" + String.format("%.4f", profitLoss) + " MAZDADY";
                
                // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù…Ø¬ØªÙ…Ø¹ÙŠØ©
                user.addCommunityPoints((int) profitLoss);
                
            } else {
                // Ø®Ø³Ø§Ø±Ø©
                profitLoss = amount * (Math.abs(priceChange) / 100);
                
                // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¥ÙÙ„Ø§Ø³: Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®Ø³Ø§Ø±Ø© = 10% Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº
                double maxLoss = amount * 0.1;
                profitLoss = Math.min(profitLoss, maxLoss);
                
                user.setBalance(user.getBalance() - profitLoss);
                resultMessage = "ğŸ’” Loss: -" + String.format("%.4f", profitLoss) + " MAZDADY";
                
                // ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø³Ø§Ø±Ø© ÙƒØ¨ÙŠØ±Ø©
                if (profitLoss >= amount * 0.05) { // 5% Ø®Ø³Ø§Ø±Ø©
                    emergencyBot.triggerEmergencyProtection(user.getUserId());
                }
            }
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø©
            TradingHistory.getInstance().recordTrade(
                tradeId,
                user.getUserId(),
                amount,
                tradeType,
                initialPrice,
                finalPrice,
                profitLoss,
                isProfit ? "PROFIT" : "LOSS"
            );
            
            System.out.println("ADVANCED TRADING: Trade completed - " + tradeId + 
                             " - " + resultMessage);
            
            // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            notifyUserOfTradeResult(user.getUserId(), resultMessage);
            
        } catch (Exception e) {
            System.err.println("TRADE COMPLETION ERROR: " + e.getMessage());
        }
    }

    private void notifyUserOfTradeResult(String userId, String message) {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        System.out.println("USER NOTIFICATION: " + userId + " - " + message);
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„
     */
    public static final class TradeResult {
        private final boolean success;
        private final boolean pending;
        private final String tradeId;
        private final double profitLoss;
        private final String message;

        private TradeResult(boolean success, boolean pending, String tradeId, double profitLoss, String message) {
            this.success = success;
            this.pending = pending;
            this.tradeId = tradeId;
            this.profitLoss = profitLoss;
            this.message = message;
        }

        public static TradeResult success(String tradeId, double profitLoss, String message) {
            return new TradeResult(true, false, tradeId, profitLoss, message);
        }

        public static TradeResult pending(String tradeId, String message) {
            return new TradeResult(true, true, tradeId, 0, message);
        }

        public static TradeResult failure(String message) {
            return new TradeResult(false, false, null, 0, message);
        }

        public boolean isSuccess() { return success; }
        public boolean isPending() { return pending; }
        public String getTradeId() { return tradeId; }
        public double getProfitLoss() { return profitLoss; }
        public String getMessage() { return message; }
    }

    /**
     * Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªØ¯Ø§ÙˆÙ„
     */
    public enum TradeType {
        BUY, SELL
    }

    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø±Ùƒ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        tradeScheduler.shutdown();
        System.out.println("ADVANCED TRADING ENGINE: Shutdown completed");
    }
}