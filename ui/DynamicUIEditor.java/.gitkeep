package mazdady.ui;

import android.content.Context;
import android.graphics.Canvas;
import android.graphics.Color;
import android.graphics.Paint;
import android.graphics.Rect;
import android.util.AttributeSet;
import android.view.View;
import android.widget.FrameLayout;

import java.util.concurrent.ConcurrentHashMap;

/**
 * Ù…Ø­Ø±Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Facade Ù„ØªÙˆÙÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©
 */
public final class DynamicUIEditor extends FrameLayout {
    private final ConcurrentHashMap<String, SmartElement> smartElements = new ConcurrentHashMap<>();
    private final Paint paint = new Paint(Paint.ANTI_ALIAS_FLAG);
    private volatile boolean editingMode = false;
    private static DynamicUIEditor instance;

    public DynamicUIEditor(Context context, AttributeSet attrs) {
        super(context, attrs);
        initializePaint();
    }

    private void initializePaint() {
        paint.setColor(Color.WHITE);
        paint.setTextSize(16f);
        paint.setTextAlign(Paint.Align.CENTER);
    }

    /**
     * ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
     */
    public void enableEditingMode() {
        this.editingMode = true;
        for (SmartElement element : smartElements.values()) {
            element.enableEditing();
        }
        Toast.makeText(getContext(), "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØ¹Ù„", Toast.LENGTH_SHORT).show();
    }

    /**
     * ØªØ¹Ø·ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
     */
    public void disableEditingMode() {
        this.editingMode = false;
        for (SmartElement element : smartElements.values()) {
            element.disableEditing();
        }
        Toast.makeText(getContext(), "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø·Ù„", Toast.LENGTH_SHORT).show();
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø°ÙƒÙŠ
     */
    public void addSmartElement(String elementId, SmartElement element) {
        smartElements.put(elementId, element);
        addView(element);
        System.out.println("DYNAMIC UI EDITOR: Added smart element - " + elementId);
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†ØµØ± Ø°ÙƒÙŠ
     */
    public void removeSmartElement(String elementId) {
        SmartElement element = smartElements.remove(elementId);
        if (element != null) {
            removeView(element);
            System.out.println("DYNAMIC UI EDITOR: Removed smart element - " + elementId);
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø°ÙƒÙŠ
     */
    public SmartElement getSmartElement(String elementId) {
        return smartElements.get(elementId);
    }

    /**
     * ØªØ·Ø¨ÙŠÙ‚ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
     */
    public void applyAdminUpdates() {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† config.json
        System.out.println("DYNAMIC UI EDITOR: Applied admin updates");
    }

    /**
     * Ø±Ø³Ù… Ù…Ø¤Ø´Ø± ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
     */
    @Override
    protected void onDraw(Canvas canvas) {
        super.onDraw(canvas);
        
        try {
            if (editingMode) {
                // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù†ØµØ±
                Rect rect = new Rect(0, 0, getWidth(), getHeight());
                paint.setStyle(Paint.Style.STROKE);
                paint.setColor(Color.BLUE);
                paint.setStrokeWidth(6f);
                canvas.drawRect(rect, paint);
                
                // Ø±Ø³Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                paint.setStyle(Paint.Style.FILL);
                paint.setColor(Color.WHITE);
                canvas.drawText("ğŸ› ï¸", getWidth() / 2f, getHeight() / 2f, paint);
            }
            
        } catch (Exception e) {
            System.err.println("DYNAMIC UI EDITOR DRAW ERROR: " + e.getMessage());
        }
    }

    // --- Getters ---
    public boolean isEditingMode() { return editingMode; }
    public int getSmartElementCount() { return smartElements.size(); }
    public void clearAllElements() {
        smartElements.clear();
        removeAllViews();
        System.out.println("DYNAMIC UI EDITOR: Cleared all elements");
    }
}