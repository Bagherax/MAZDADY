package mazdady.ui;

import android.view.View;
import android.view.ViewGroup;
import android.widget.FrameLayout;

import mazdady.admin.AdminConfig;

/**
 * مدير التخطيط الديناميكي مع دعم التحديثات الحية
 * يتبع نمط Observer لإعلام المكونات بالتغيرات
 */
public final class DynamicLayoutManager {
    private final ViewGroup rootView;
    private final LayoutCustomizer layoutCustomizer;

    public DynamicLayoutManager(ViewGroup rootView) {
        this.rootView = rootView;
        this.layoutCustomizer = new LayoutCustomizer();
    }

    /**
     * تطبيق التخطيط الديناميكي
     */
    public void applyLayout() {
        AdminConfig.UIConfig uiConfig = AdminConfig.getInstance().getUIConfig();
        
        // تطبيق التخصيصات من الإدارة
        layoutCustomizer.customizeLayout(rootView, uiConfig);
        
        // تطبيق العناصر الديناميكية
        applyDynamicElements(uiConfig);
        
        System.out.println("DYNAMIC LAYOUT: Layout applied successfully");
    }

    /**
     * تطبيق العناصر الديناميكية
     */
    private void applyDynamicElements(AdminConfig.UIConfig uiConfig) {
        // تطبيق زر الإعلان العائم
        if (uiConfig.getFloatingAdConfig().isEnabled()) {
            FloatingAdButton adButton = new FloatingAdButton(rootView.getContext(), null);
            adButton.configure(
                uiConfig.getFloatingAdConfig().getDisplayDuration(),
                uiConfig.getFloatingAdConfig().getHideDuration(),
                uiConfig.getFloatingAdConfig().getAdImageUrl()
            );
            
            FrameLayout.LayoutParams params = new FrameLayout.LayoutParams(
                dpToPx(120),
                dpToPx(120)
            );
            params.gravity = android.view.Gravity.BOTTOM | android.view.Gravity.END;
            params.rightMargin = dpToPx(20);
            params.bottomMargin = dpToPx(20);
            
            rootView.addView(adButton, params);
            System.out.println("DYNAMIC LAYOUT: Floating ad button added");
        }
        
        // تطبيق عناصر أخرى ديناميكية
        applyAdditionalElements(uiConfig);
    }

    /**
     * تطبيق عناصر إضافية
     */
    private void applyAdditionalElements(AdminConfig.UIConfig uiConfig) {
        // في الإنتاج: تطبيق عناصر إضافية من الإعدادات
        System.out.println("DYNAMIC LAYOUT: Additional elements applied");
    }

    /**
     * تحديث التخطيط ديناميكيًا
     */
    public void updateLayout() {
        AdminConfig.UIConfig uiConfig = AdminConfig.getInstance().getUIConfig();
        layoutCustomizer.customizeLayout(rootView, uiConfig);
        System.out.println("DYNAMIC LAYOUT: Layout updated dynamically");
    }

    /**
     * إزالة جميع العناصر الديناميكية
     */
    public void clearDynamicElements() {
        // في الإنتاج: إزالة العناصر المضافة ديناميكيًا
        System.out.println("DYNAMIC LAYOUT: Dynamic elements cleared");
    }

    /**
     * تحويل DP إلى بكسل
     */
    private int dpToPx(float dp) {
        return Math.round(dp * rootView.getContext().getResources().getDisplayMetrics().density);
    }
}