package mazdady.preview;

import mazdady.admin.AdminConfig;
import mazdady.user.User;
import mazdady.user.UserManager;

import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;

/**
 * Ù…Ø¯ÙŠØ± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­ÙŠØ©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Facade Ù„ØªÙˆÙÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©
 */
public final class FieldPreviewManager {
    private final Map<String, PreviewField> previewFields = new ConcurrentHashMap<>();
    private final ScheduledExecutorService updateScheduler = Executors.newScheduledThreadPool(1);
    private final AdminConfig adminConfig;
    private static FieldPreviewManager instance;

    private FieldPreviewManager(AdminConfig adminConfig) {
        this.adminConfig = adminConfig;
        startLiveUpdates();
    }

    public static synchronized FieldPreviewManager getInstance(AdminConfig adminConfig) {
        if (instance == null) {
            instance = new FieldPreviewManager(adminConfig);
        }
        return instance;
    }

    private void startLiveUpdates() {
        updateScheduler.scheduleAtFixedRate(
            this::updateAllPreviews,
            0,
            30,
            TimeUnit.SECONDS
        );
        
        System.out.println("FIELD PREVIEW MANAGER: Started live updates every 30 seconds");
    }

    /**
     * ØªØ³Ø¬ÙŠÙ„ Ø­Ù‚Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯
     */
    public void registerPreviewField(String fieldId, PreviewField previewField) {
        if (fieldId != null && previewField != null) {
            previewFields.put(fieldId, previewField);
            System.out.println("FIELD PREVIEW MANAGER: Registered preview field - " + fieldId);
        }
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø©
     */
    public void unregisterPreviewField(String fieldId) {
        PreviewField removed = previewFields.remove(fieldId);
        if (removed != null) {
            removed.shutdown();
            System.out.println("FIELD PREVIEW MANAGER: Unregistered preview field - " + fieldId);
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<PreviewResult> updatePreviewFieldAsync(
        String fieldId, 
        String content, 
        PreviewField.PreviewState state
    ) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                PreviewField previewField = previewFields.get(fieldId);
                if (previewField == null) {
                    return PreviewResult.failure("Preview field not found: " + fieldId);
                }
                
                previewField.updatePreviewAsync(content, state);
                
                System.out.println("FIELD PREVIEW MANAGER: Updated preview field " + fieldId + 
                                 " - State: " + state + " - Content: " + content);
                
                return PreviewResult.success("Preview field updated successfully");
                
            } catch (Exception e) {
                return PreviewResult.failure("Preview field update failed: " + e.getMessage());
            }
        });
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    private void updateAllPreviews() {
        try {
            for (Map.Entry<String, PreviewField> entry : previewFields.entrySet()) {
                String fieldId = entry.getKey();
                PreviewField previewField = entry.getValue();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚Ù„
                String content = generatePreviewContent(fieldId);
                PreviewField.PreviewState state = determinePreviewState(fieldId);
                
                previewField.updatePreviewAsync(content, state);
            }
            
            System.out.println("FIELD PREVIEW MANAGER: Updated all " + previewFields.size() + " preview fields");
            
        } catch (Exception e) {
            System.err.println("ALL PREVIEWS UPDATE ERROR: " + e.getMessage());
        }
    }

    private String generatePreviewContent(String fieldId) {
        switch (fieldId) {
            case "balance_preview":
                User user = UserManager.getInstance(null).getCurrentUser();
                return String.format("Ø§Ù„Ø±ØµÙŠØ¯: %.2f MAZDADY", user.getBalance());
                
            case "level_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return "Ø§Ù„Ù…Ø³ØªÙˆÙ‰: " + user.getLevel();
                
            case "community_points_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return "Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬ØªÙ…Ø¹: " + user.getCommunityPoints();
                
            case "referral_count_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return "Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª: " + user.getReferralCount();
                
            case "streak_days_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return "Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø£ÙŠØ§Ù…: " + user.getStreakDays() + " ÙŠÙˆÙ…";
                
            case "recent_profit_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return user.hasRecentProfit() ? "Ø±Ø¨Ø­ Ø­Ø¯ÙŠØ«!" : "Ù„Ø§ Ø£Ø±Ø¨Ø§Ø­ Ø­Ø¯ÙŠØ«Ø©";
                
            case "kyc_status_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return user.isKYCVerified() ? "âœ… ØªÙˆØ«ÙŠÙ‚ Ù…ÙƒØªÙ…Ù„" : "âŒ ØªÙˆØ«ÙŠÙ‚ Ù…Ø·Ù„ÙˆØ¨";
                
            case "subscription_status_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return user.hasActiveSubscription() ? "â­ Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·" : "ğŸ†“ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¬Ø§Ù†ÙŠ";
                
            case "wallet_status_preview":
                user = UserManager(null).getCurrentUser();
                return user.getWalletAddress() != null ? "ğŸ‘› Ù…Ø­ÙØ¸Ø© Ù…ØªØµÙ„Ø©" : "ğŸ”— Ø±Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø©";
                
            case "security_status_preview":
                return "ğŸ›¡ï¸ Ø£Ù…Ø§Ù† Ù…ÙØ¹Ù„";
                
            default:
                return "Ù…Ø¹Ø§ÙŠÙ†Ø© " + fieldId;
        }
    }

    private PreviewField.PreviewState determinePreviewState(String fieldId) {
        switch (fieldId) {
            case "balance_preview":
            case "level_preview":
            case "community_points_preview":
            case "referral_count_preview":
            case "streak_days_preview":
                return PreviewField.PreviewState.SUCCESS;
                
            case "recent_profit_preview":
                User user = UserManager.getInstance(null).getCurrentUser();
                return user.hasRecentProfit() ? 
                    PreviewField.PreviewState.SUCCESS : 
                    PreviewField.PreviewState.EMPTY;
                    
            case "kyc_status_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return user.isKYCVerified() ? 
                    PreviewField.PreviewState.SUCCESS : 
                    PreviewField.PreviewState.ERROR;
                    
            case "subscription_status_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return user.hasActiveSubscription() ? 
                    PreviewField.PreviewState.SUCCESS : 
                    PreviewField.PreviewState.PROCESSING;
                    
            case "wallet_status_preview":
                user = UserManager.getInstance(null).getCurrentUser();
                return user.getWalletAddress() != null ? 
                    PreviewField.PreviewState.SUCCESS : 
                    PreviewField.PreviewState.LOADING;
                    
            case "security_status_preview":
                return PreviewField.PreviewState.SUCCESS;
                
            default:
                return PreviewField.PreviewState.LOADING;
        }
    }

    /**
     * ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø©
     */
    public void applyVisualEffectToField(String fieldId, PreviewField.VisualEffect effect) {
        PreviewField previewField = previewFields.get(fieldId);
        if (previewField != null) {
            previewField.applyVisualEffects(effect);
            System.out.println("FIELD PREVIEW MANAGER: Applied visual effect " + effect + 
                             " to field " + fieldId);
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
     */
    public void updatePreviewConfigFromAdmin(AdminConfig.UIConfig.PreviewFieldConfig config) {
        if (config != null) {
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            System.out.println("FIELD PREVIEW MANAGER: Updated preview config from admin");
        }
    }

    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¯ÙŠØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        updateScheduler.shutdown();
        previewFields.values().forEach(PreviewField::shutdown);
        previewFields.clear();
        System.out.println("FIELD PREVIEW MANAGER: Shutdown completed");
    }

    // --- Getters ---
    public int getPreviewFieldCount() { return previewFields.size(); }
    public boolean hasPreviewField(String fieldId) { return previewFields.containsKey(fieldId); }
    public PreviewField getPreviewField(String fieldId) { return previewFields.get(fieldId); }
    public Map<String, PreviewField> getPreviewFields() { return new ConcurrentHashMap<>(previewFields); }
    
    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯ÙŠØ± (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void reset() {
        previewFields.clear();
        System.out.println("FIELD PREVIEW MANAGER: Reset completed");
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
     */
    public static final class PreviewResult {
        private final boolean success;
        private final String message;

        private PreviewResult(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public static PreviewResult success(String message) {
            return new PreviewResult(true, message);
        }

        public static PreviewResult failure(String message) {
            return new PreviewResult(false, message);
        }

        public boolean isSuccess() { return success; }
        public String getMessage() { return message; }
    }
}