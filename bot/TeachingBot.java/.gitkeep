package mazdady.bot;

import mazdady.trading.PriceEngine;
import mazdady.user.User;
import mazdady.user.UserManager;

import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.TimeUnit;

/**
 * Ø¨ÙˆØª ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø°ÙƒÙŠ
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Observer Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù†ØµØ§Ø¦Ø­
 */
public final class TeachingBot extends TradingBot {
    private final ScheduledExecutorService teachingScheduler = Executors.newSingleThreadScheduledExecutor();
    private final PriceEngine priceEngine;

    public TeachingBot(String botId, PriceEngine priceEngine) {
        super(botId, priceEngine);
        this.priceEngine = priceEngine;
        setCapital(1000.0); // Ø±Ø£Ø³ Ù…Ø§Ù„ ØªØ¹Ù„ÙŠÙ…ÙŠ
    }

    @Override
    public void start() {
        if (isActive.compareAndSet(false, true)) {
            teachingScheduler.scheduleAtFixedRate(
                this::provideEducationalInsights,
                0,
                60,
                TimeUnit.SECONDS
            );
            
            System.out.println("TEACHING BOT: Started - ID: " + getBotId());
        }
    }

    @Override
    public void stop() {
        if (isActive.compareAndSet(true, false)) {
            teachingScheduler.shutdown();
            System.out.println("TEACHING BOT: Stopped - ID: " + getBotId());
        }
    }

    /**
     * ØªÙ‚Ø¯ÙŠÙ… Ø±Ø¤Ù‰ ØªØ¹Ù„ÙŠÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
     */
    private void provideEducationalInsights() {
        if (!isActive.get()) return;
        
        try {
            User user = UserManager.getInstance(null).getCurrentUser();
            double currentPrice = priceEngine.getCurrentPrice();
            double trend = priceEngine.getMarketTrend();
            double volatility = priceEngine.getVolatility();
            
            String insight = generateEducationalInsight(user, currentPrice, trend, volatility);
            if (insight != null && !insight.isEmpty()) {
                notifyUserInsight(user.getUserId(), insight);
            }
            
        } catch (Exception e) {
            System.err.println("TEACHING BOT ERROR: " + e.getMessage());
        }
    }

    private String generateEducationalInsight(User user, double price, double trend, double volatility) {
        // ØªÙˆÙ„ÙŠØ¯ Ù†ØµØ§Ø¦Ø­ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (user.getLevel() <= 2) {
            // Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨ØªØ¯Ø¦
            if (trend > 0.5) {
                return "ğŸ’¡ Ù†ØµÙŠØ­Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©: Ø§Ù„Ø³ÙˆÙ‚ ØµØ§Ø¹Ø¯! Ø¬Ø±Ø¨ Ø´Ø±Ø§Ø¡ ÙƒÙ…ÙŠØ© ØµØºÙŠØ±Ø© Ø§Ù„Ø¢Ù†.";
            } else if (trend < -0.5) {
                return "ğŸ’¡ Ù†ØµÙŠØ­Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©: Ø§Ù„Ø³ÙˆÙ‚ Ù‡Ø§Ø¨Ø·! Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØ±ØªØ¯.";
            } else {
                return "ğŸ’¡ Ù†ØµÙŠØ­Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©: Ø§Ù„Ø³ÙˆÙ‚ Ù…Ø³ØªÙ‚Ø±! Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØºÙŠØ±Ø§Øª.";
            }
        } else if (user.getLevel() <= 5) {
            // Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªÙˆØ³Ø·
            return "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚: Ø§Ù„ØªÙ‚Ù„Ø¨ " + String.format("%.1f", volatility * 100) + 
                   "% | Ø§Ù„Ø§ØªØ¬Ø§Ù‡ " + (trend > 0 ? "ØµØ§Ø¹Ø¯" : "Ù‡Ø§Ø¨Ø·") + 
                   " | Ø§Ù„Ø³Ø¹Ø± " + String.format("%.2f", price);
        } else {
            // Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªÙ‚Ø¯Ù…
            double support = price * 0.95;
            double resistance = price * 1.05;
            return "ğŸ”® ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù…: Ø§Ù„Ø¯Ø¹Ù… = " + String.format("%.2f", support) + 
                   ", Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© = " + String.format("%.2f", resistance) + 
                   ", Ø§Ù„ØªÙ‚Ù„Ø¨ = " + String.format("%.1f", volatility * 100) + "%";
        }
    }

    private void notifyUserInsight(String userId, String insight) {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        System.out.println("TEACHING BOT: Insight for " + userId + " - " + insight);
    }

    /**
     * ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© ØªØ¬Ø§Ø±ÙŠØ©
     */
    @Override
    public void executeTrade(TradeType tradeType, double amount) {
        if (!isActive.get() || amount <= 0) return;
        
        try {
            User user = UserManager.getInstance(null).getCurrentUser();
            double userBalance = user.getBalance();
            
            if (userBalance < amount) {
                notifyUserInsight(user.getUserId(), "âš ï¸ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ù„ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØµÙÙ‚Ø©.");
                return;
            }
            
            if (tradeType == TradeType.BUY) {
                priceEngine.executeBuyOrder(getBotId(), amount);
                user.setBalance(userBalance - amount);
                notifyUserInsight(user.getUserId(), "âœ… ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø´Ø±Ø§Ø¡ Ø¨Ù‚ÙŠÙ…Ø© " + amount + " MAZDADY");
            } else if (tradeType == TradeType.SELL) {
                priceEngine.executeSellOrder(getBotId(), amount);
                user.setBalance(userBalance + amount);
                notifyUserInsight(user.getUserId(), "âœ… ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø¨ÙŠØ¹ Ø¨Ù‚ÙŠÙ…Ø© " + amount + " MAZDADY");
            }
            
        } catch (Exception e) {
            System.err.println("TEACHING BOT TRADE ERROR: " + e.getMessage());
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
     */
    public TeachingStatus getTeachingStatus() {
        User user = UserManager.getInstance(null).getCurrentUser();
        return new TeachingStatus(
            user.getLevel(),
            user.getBalance(),
            priceEngine.getCurrentPrice(),
            isActive.get()
        );
    }

    /**
     * Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
     */
    public static final class TeachingStatus {
        private final int userLevel;
        private final double userBalance;
        private final double currentPrice;
        private final boolean active;

        public TeachingStatus(int userLevel, double userBalance, double currentPrice, boolean active) {
            this.userLevel = userLevel;
            this.userBalance = userBalance;
            this.currentPrice = currentPrice;
            this.active = active;
        }

        // Getters
        public int getUserLevel() { return userLevel; }
        public double getUserBalance() { return userBalance; }
        public double getCurrentPrice() { return currentPrice; }
        public boolean isActive() { return active; }
        
        public String getFormattedStatus() {
            return "User Level: " + userLevel + " - " +
                   "Balance: " + String.format("%.2f", userBalance) + " MAZDADY - " +
                   "Price: " + String.format("%.4f", currentPrice) + " MAZDADY - " +
                   "Status: " + (active ? "ACTIVE" : "INACTIVE");
        }
    }

    // --- Getters ---
    public PriceEngine getPriceEngine() { return priceEngine; }
    public boolean isTeachingActive() { return isActive.get(); }
    
    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        stop();
        System.out.println("TEACHING BOT: Shutdown completed - ID: " + getBotId());
    }
}