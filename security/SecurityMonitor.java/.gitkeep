package mazdady.security;

import android.content.Context;

import java.time.Instant;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;

/**
 * Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ù…Ø§Ù† Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø­ÙŠØ©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Observer Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©
 */
public final class SecurityMonitor {
    private final Context context;
    private final CopyOnWriteArrayList<Consumer<SecurityEvent>> listeners = new CopyOnWriteArrayList<>();
    private final ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();
    private int suspiciousActivityCount = 0;
    private static final int MAX_SUSPICIOUS_ACTIVITIES = 3;

    private SecurityMonitor(Context context) {
        this.context = context.getApplicationContext();
        startSecurityMonitoring();
    }

    public static SecurityMonitor create(Context context) {
        return new SecurityMonitor(context);
    }

    private void startSecurityMonitoring() {
        scheduler.scheduleAtFixedRate(
            this::performSecurityCheck,
            0,
            5,
            TimeUnit.MINUTES
        );
    }

    /**
     * Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡
     */
    public void reportSuspiciousActivity(String activityType) {
        suspiciousActivityCount++;
        SecurityEvent event = new SecurityEvent(
            activityType,
            "Suspicious activity #" + suspiciousActivityCount,
            Instant.now()
        );
        notifyListeners(event);

        if (suspiciousActivityCount >= MAX_SUSPICIOUS_ACTIVITIES) {
            triggerSecurityLockdown();
        }
    }

    private void performSecurityCheck() {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        if (!AppIntegrityChecker.create(context).isAppIntegrityValid()) {
            reportSuspiciousActivity("MODIFIED_APP");
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø°ÙˆØ±
        if (RootDetector.isDeviceRooted()) {
            reportSuspiciousActivity("ROOTED_DEVICE");
        }
    }

    private void triggerSecurityLockdown() {
        SecurityEvent event = new SecurityEvent(
            "SECURITY_LOCKDOWN",
            "Security lockdown triggered due to excessive suspicious activities",
            Instant.now()
        );
        notifyListeners(event);
        
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø§Ø¯Ù…Ù†
        System.out.println("ğŸš¨ SECURITY LOCKDOWN: Account frozen due to suspicious activities");
    }

    private void notifyListeners(SecurityEvent event) {
        listeners.forEach(listener -> {
            try {
                listener.accept(event);
            } catch (Exception e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
            }
        });
    }

    public void addSecurityListener(Consumer<SecurityEvent> listener) {
        listeners.add(listener);
    }

    public void removeSecurityListener(Consumer<SecurityEvent> listener) {
        listeners.remove(listener);
    }

    public void resetSuspiciousCount() {
        suspiciousActivityCount = 0;
    }

    /**
     * Ø­Ø¯Ø« Ø§Ù„Ø£Ù…Ø§Ù†
     */
    public static final class SecurityEvent {
        private final String type;
        private final String description;
        private final Instant timestamp;

        public SecurityEvent(String type, String description, Instant timestamp) {
            this.type = type;
            this.description = description;
            this.timestamp = timestamp;
        }

        public String getType() { return type; }
        public String getDescription() { return description; }
        public Instant getTimestamp() { return timestamp; }
    }

    /**
     * Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void shutdown() {
        scheduler.shutdown();
    }
}