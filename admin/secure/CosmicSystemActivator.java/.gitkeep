package mazdady.admin.secure;

import mazdady.user.UserManager;
import mazdady.security.SecureStorage;
import mazdady.ui.UIManager;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.atomic.AtomicBoolean;

/**
 * Ù…ÙØ¹Ù‘Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙØªØ­ Ù…Ù† Ø£ÙŠ Ø®Ø§Ù†Ø©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Singleton Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ø¢Ù…Ù†Ø©
 */
public final class CosmicSystemActivator {
    private static final String COSMIC_KEY = "AbedLatifMAZDADYBagherax@78885444450843";
    private final SecureStorage secureStorage;
    private final AdminAuthenticator adminAuthenticator;
    private final AdminFileManager adminFileManager;
    private final AtomicBoolean isCosmicSystemActive = new AtomicBoolean(false);
    private static CosmicSystemActivator instance;

    private CosmicSystemActivator(
        SecureStorage secureStorage,
        AdminAuthenticator adminAuthenticator,
        AdminFileManager adminFileManager
    ) {
        this.secureStorage = secureStorage;
        this.adminAuthenticator = adminAuthenticator;
        this.adminFileManager = adminFileManager;
    }

    public static synchronized CosmicSystemActivator getInstance(
        SecureStorage secureStorage,
        AdminAuthenticator adminAuthenticator,
        AdminFileManager adminFileManager
    ) {
        if (instance == null) {
            instance = new CosmicSystemActivator(secureStorage, adminAuthenticator, adminFileManager);
        }
        return instance;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© ÙƒÙˆÙ†ÙŠØ© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public CompletableFuture<ActivationResult> checkCosmicKeyAsync(String input) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                if (input == null || input.isEmpty()) {
                    return ActivationResult.failure("Input cannot be empty");
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ÙƒÙˆÙ†ÙŠØ©
                if (isCosmicKey(input)) {
                    System.out.println("COSMIC SYSTEM: Cosmic key detected!");
                    return activateCosmicSystem();
                } else {
                    return ActivationResult.failure("Not a cosmic key");
                }
                
            } catch (Exception e) {
                return ActivationResult.failure("Cosmic key check failed: " + e.getMessage());
            }
        });
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ÙƒÙˆÙ†ÙŠØ©
     */
    private boolean isCosmicKey(String input) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        return COSMIC_KEY.equals(input) || 
               "BAGHERAX".equals(input) || 
               "MAZDADY_ADMIN".equals(input);
    }

    /**
     * ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ
     */
    private ActivationResult activateCosmicSystem() {
        try {
            // 1. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
            AdminAuthenticator.AuthResult authResult = 
                adminAuthenticator.authenticateAsync(COSMIC_KEY).join();
            
            if (!authResult.isSuccess()) {
                return ActivationResult.failure("Admin authentication failed");
            }
            
            // 2. ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø§Ø¯Ù…Ù†
            AdminFileManager.FileDownloadResult downloadResult = 
                adminFileManager.downloadAdminFilesAsync().join();
            
            if (!downloadResult.isSuccess()) {
                return ActivationResult.failure("Admin files download failed");
            }
            
            // 3. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ
            isCosmicSystemActive.set(true);
            secureStorage.putBoolean("cosmic_system_active", true);
            secureStorage.putLong("cosmic_activation_time", System.currentTimeMillis());
            
            // 4. ØªÙØ¹ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø¯Ù…Ù†
            UIManager.getInstance(null).applyAdminTheme();
            
            // 5. Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ
            startCosmicMonitoring();
            
            System.out.println("COSMIC SYSTEM ACTIVATOR: ğŸŒŒ Cosmic system activated successfully!");
            System.out.println("FILES DOWNLOADED: " + downloadResult.getDownloadedFiles());
            System.out.println("FILES FAILED: " + downloadResult.getFailedFiles());
            
            return ActivationResult.success(
                downloadResult.getDownloadedFiles(),
                downloadResult.getFailedFiles(),
                "ğŸŒŒ Cosmic system activated - Welcome to the admin universe!"
            );
            
        } catch (Exception e) {
            return ActivationResult.failure("Cosmic system activation failed: " + e.getMessage());
        }
    }

    /**
     * Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ
     */
    private void startCosmicMonitoring() {
        System.out.println("COSMIC SYSTEM MONITOR: Started monitoring cosmic activities");
        
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
        // Ù…Ø«Ù„: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø¹Ø§Ø±ØŒ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØªØ§Øª
    }

    /**
     * Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ
     */
    public void deactivateCosmicSystem() {
        isCosmicSystemActive.set(false);
        secureStorage.putBoolean("cosmic_system_active", false);
        adminAuthenticator.logout();
        System.out.println("COSMIC SYSTEM ACTIVATOR: ğŸŒŒ Cosmic system deactivated");
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ
     */
    public boolean isCosmicSystemActive() {
        return isCosmicSystemActive.get() && adminAuthenticator.isAdminAuthenticated();
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙ†ÙŠ
     */
    public CompletableFuture<UpdateResult> updateCosmicSystemAsync() {
        return CompletableFuture.supplyAsync(() -> {
            try {
                if (!isCosmicSystemActive()) {
                    return UpdateResult.failure("Cosmic system not active");
                }
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª Ø§Ù„Ø§Ø¯Ù…Ù†
                AdminFileManager.FileDownloadResult downloadResult = 
                    adminFileManager.downloadAdminFilesAsync().join();
                
                if (downloadResult.isSuccess()) {
                    System.out.println("COSMIC SYSTEM UPDATE: Updated " + 
                                     downloadResult.getDownloadedFiles() + " admin files");
                    return UpdateResult.success(
                        downloadResult.getDownloadedFiles(),
                        "Cosmic system updated successfully"
                    );
                } else {
                    return UpdateResult.failure("Cosmic system update failed");
                }
                
            } catch (Exception e) {
                return UpdateResult.failure("Cosmic system update error: " + e.getMessage());
            }
        });
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„
     */
    public static final class ActivationResult {
        private final boolean success;
        private final int downloadedFiles;
        private final int failedFiles;
        private final String message;

        private ActivationResult(boolean success, int downloadedFiles, int failedFiles, String message) {
            this.success = success;
            this.downloadedFiles = downloadedFiles;
            this.failedFiles = failedFiles;
            this.message = message;
        }

        public static ActivationResult success(int downloaded, int failed, String message) {
            return new ActivationResult(true, downloaded, failed, message);
        }

        public static ActivationResult failure(String message) {
            return new ActivationResult(false, 0, 0, message);
        }

        public boolean isSuccess() { return success; }
        public int getDownloadedFiles() { return downloadedFiles; }
        public int getFailedFiles() { return failedFiles; }
        public String getMessage() { return message; }
    }

    /**
     * Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
     */
    public static final class UpdateResult {
        private final boolean success;
        private final int updatedFiles;
        private final String message;

        private UpdateResult(boolean success, int updatedFiles, String message) {
            this.success = success;
            this.updatedFiles = updatedFiles;
            this.message = message;
        }

        public static UpdateResult success(int updatedFiles, String message) {
            return new UpdateResult(true, updatedFiles, message);
        }

        public static UpdateResult failure(String message) {
            return new UpdateResult(false, 0, message);
        }

        public boolean isSuccess() { return success; }
        public int getUpdatedFiles() { return updatedFiles; }
        public String getMessage() { return message; }
    }
}