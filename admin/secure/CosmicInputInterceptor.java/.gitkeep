package mazdady.admin.secure;

import android.text.Editable;
import android.text.TextWatcher;
import android.widget.EditText;

import java.util.concurrent.CompletableFuture;
import java.util.function.Consumer;

/**
 * Ø§Ø¹ØªØ±Ø§Ø¶ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ÙƒÙˆÙ†ÙŠØ©
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Observer Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ÙƒÙˆÙ†ÙŠØ©
 */
public final class CosmicInputInterceptor implements TextWatcher {
    private final EditText inputField;
    private final Consumer<CosmicSystemActivator.ActivationResult> onCosmicKeyDetected;
    private final CosmicSystemActivator cosmicActivator;
    private final StringBuilder inputBuffer = new StringBuilder();
    private static final int BUFFER_SIZE = 100;

    private CosmicInputInterceptor(
        EditText inputField,
        Consumer<CosmicSystemActivator.ActivationResult> onCosmicKeyDetected,
        CosmicSystemActivator cosmicActivator
    ) {
        this.inputField = inputField;
        this.onCosmicKeyDetected = onCosmicKeyDetected;
        this.cosmicActivator = cosmicActivator;
        inputField.addTextChangedListener(this);
    }

    public static CosmicInputInterceptor attach(
        EditText inputField,
        Consumer<CosmicSystemActivator.ActivationResult> onCosmicKeyDetected,
        CosmicSystemActivator cosmicActivator
    ) {
        return new CosmicInputInterceptor(inputField, onCosmicKeyDetected, cosmicActivator);
    }

    @Override
    public void beforeTextChanged(CharSequence s, int start, int count, int after) {
        // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø´ÙŠØ¡ Ù‡Ù†Ø§
    }

    @Override
    public void onTextChanged(CharSequence s, int start, int before, int count) {
        // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø´ÙŠØ¡ Ù‡Ù†Ø§
    }

    @Override
    public void afterTextChanged(Editable s) {
        try {
            String currentText = s.toString();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª
            updateInputBuffer(currentText);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ÙƒÙˆÙ†ÙŠØ©
            checkForCosmicKey(currentText);
            
        } catch (Exception e) {
            System.err.println("COSMIC INPUT INTERCEPTOR ERROR: " + e.getMessage());
        }
    }

    private void updateInputBuffer(String text) {
        inputBuffer.append(text);
        
        // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª
        if (inputBuffer.length() > BUFFER_SIZE) {
            inputBuffer.delete(0, inputBuffer.length() - BUFFER_SIZE);
        }
    }

    private void checkForCosmicKey(String currentText) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ
        cosmicActivator.checkCosmicKeyAsync(currentText)
            .thenAccept(result -> {
                if (result.isSuccess()) {
                    handleCosmicKeyDetected(result);
                }
            });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª
        if (inputBuffer.length() >= 20) { // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø·ÙˆÙ„ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ÙƒÙˆÙ†ÙŠØ©
            String bufferText = inputBuffer.toString();
            cosmicActivator.checkCosmicKeyAsync(bufferText)
                .thenAccept(result -> {
                    if (result.isSuccess()) {
                        handleCosmicKeyDetected(result);
                    }
                });
        }
    }

    private void handleCosmicKeyDetected(CosmicSystemActivator.ActivationResult result) {
        if (onCosmicKeyDetected != null) {
            inputField.post(() -> onCosmicKeyDetected.accept(result));
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
        showCosmicEffect();
        
        System.out.println("COSMIC INPUT INTERCEPTOR: ğŸŒŒ Cosmic key detected and handled!");
    }

    private void showCosmicEffect() {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¹Ø±Ø¶ ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù…Ø°Ù‡Ù„
        System.out.println("COSMIC EFFECT: ğŸŒŸâœ¨ğŸŒŒ Activating cosmic system...");
        
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ÙƒÙˆÙ†
        for (int i = 0; i < 5; i++) {
            System.out.println("COSMIC STAR: â­" + " ".repeat(i) + "âœ¨");
        }
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø§Ø¹ØªØ±Ø§Ø¶ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void detach() {
        inputField.removeTextChangedListener(this);
        inputBuffer.setLength(0);
        System.out.println("COSMIC INPUT INTERCEPTOR: Detached from input field");
    }

    // --- Getters ---
    public String getCurrentInput() { return inputBuffer.toString(); }
    public int getInputLength() { return inputBuffer.length(); }
    public boolean isAttached() { return inputField.getTag() instanceof CosmicInputInterceptor; }
    
    /**
     * Ù…Ø³Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void clearInput() {
        inputBuffer.setLength(0);
        inputField.setText("");
        System.out.println("COSMIC INPUT INTERCEPTOR: Input cleared");
    }
}