package mazdady.svc;

import mazdady.withdrawal.WithdrawalRulesEngine;
import mazdady.wallet.WalletManager;
import mazdady.user.UserManager;

import java.util.concurrent.CompletableFuture;

/**
 * خدمة السحب مع دعم القواعد المتقدمة
 * يتبع نمط Facade لتوفير واجهة موحدة
 */
public final class WithdrawalService {
    private final WithdrawalRulesEngine rulesEngine;
    private static WithdrawalService instance;

    private WithdrawalService() {
        this.rulesEngine = new WithdrawalRulesEngine();
    }

    public static synchronized WithdrawalService getInstance() {
        if (instance == null) {
            instance = new WithdrawalService();
        }
        return instance;
    }

    /**
     * معالجة سحب غير متزامن
     */
    public CompletableFuture<WithdrawalResult> processWithdrawalAsync(double amount) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                var user = UserManager.getInstance(null).getCurrentUser();
                
                // التحقق من القواعد
                var validationResult = rulesEngine.canWithdraw(user, amount);
                if (!validationResult.isAllowed()) {
                    return WithdrawalResult.failure(validationResult.getMessage());
                }
                
                // تنفيذ السحب
                WalletManager wallet = new WalletManager();
                boolean success = wallet.withdrawMAZDADY(amount);
                
                if (success) {
                    user.addWeeklyWithdrawn(amount);
                    System.out.println("WITHDRAWAL PROCESSED: " + amount + " MAZDADY for user " + user.getUserId());
                    return WithdrawalResult.success("Withdrawal processed successfully");
                } else {
                    return WithdrawalResult.failure("Withdrawal execution failed");
                }
                
            } catch (Exception e) {
                return WithdrawalResult.failure("Withdrawal processing error: " + e.getMessage());
            }
        });
    }

    /**
     * نتيجة السحب
     */
    public static final class WithdrawalResult {
        private final boolean success;
        private final String message;

        private WithdrawalResult(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public static WithdrawalResult success(String message) {
            return new WithdrawalResult(true, message);
        }

        public static WithdrawalResult failure(String message) {
            return new WithdrawalResult(false, message);
        }

        public boolean isSuccess() { return success; }
        public String getMessage() { return message; }
    }
}