package mazdady.user;

import mazdady.admin.AdminConfig;
import mazdady.social.Achievements;

import java.time.Instant;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ®ØµÙŠØµ
 * ÙŠØªØ¨Ø¹ Ù†Ù…Ø· Strategy Ù„ÙØµÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©
 */
public final class LevelSystem {
    private final Map<Integer, LevelConfig> levelConfigs = new ConcurrentHashMap<>();
    private final Map<String, UserLevelProgress> userProgress = new ConcurrentHashMap<>();
    private static LevelSystem instance;

    private LevelSystem() {
        initializeDefaultLevels();
    }

    public static synchronized LevelSystem getInstance() {
        if (instance == null) {
            instance = new LevelSystem();
        }
        return instance;
    }

    private void initializeDefaultLevels() {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        levelConfigs.put(1, new LevelConfig(1, 100, "Ù…Ø¨ØªØ¯Ø¦", "ğŸ¥‰", "#FFD700"));
        levelConfigs.put(2, new LevelConfig(2, 1000, "Ù…ØªÙ‚Ø¯Ù…", "ğŸ¥ˆ", "#C0C0C0"));
        levelConfigs.put(3, new LevelConfig(3, 5000, "Ø®Ø¨ÙŠØ±", "ğŸ¥‡", "#FFD700"));
        levelConfigs.put(4, new LevelConfig(4, 10000, "Ù…Ø§Ø¬Ø³ØªÙŠØ±", "ğŸ†", "#4CAF50"));
        levelConfigs.put(5, new LevelConfig(5, 25000, "Ø£Ø³ØªØ§Ø°", "ğŸ‘‘", "#2196F3"));
        
        System.out.println("LEVEL SYSTEM: Initialized " + levelConfigs.size() + " default levels");
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public void updateLevelRulesFromAdminAsync(AdminConfig.LevelConfig adminLevelConfig) {
        new Thread(() -> {
            try {
                if (adminLevelConfig == null) return;
                
                Map<Integer, AdminConfig.LevelConfig.LevelDefinition> definitions = 
                    adminLevelConfig.getLevelDefinitions();
                
                levelConfigs.clear();
                definitions.forEach((level, definition) -> {
                    levelConfigs.put(level, new LevelConfig(
                        level,
                        definition.getRequiredWins(),
                        definition.getLevelName(),
                        definition.getBadgeEmoji(),
                        definition.getBadgeColor()
                    ));
                });
                
                System.out.println("LEVEL SYSTEM: Updated level rules from admin config - " + 
                                 levelConfigs.size() + " levels");
                
            } catch (Exception e) {
                System.err.println("LEVEL RULES UPDATE ERROR: " + e.getMessage());
            }
        }).start();
    }

    /**
     * Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public int calculateCurrentLevel(String userId, int winCount) {
        try {
            // ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            UserLevelProgress progress = userProgress.computeIfAbsent(
                userId, 
                k -> new UserLevelProgress(userId)
            );
            progress.updateWinCount(winCount);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
            int currentLevel = 1;
            for (Map.Entry<Integer, LevelConfig> entry : levelConfigs.entrySet()) {
                LevelConfig config = entry.getValue();
                if (winCount >= config.getRequiredWins()) {
                    currentLevel = Math.max(currentLevel, config.getLevel());
                }
            }
            
            System.out.println("LEVEL SYSTEM: User " + userId + " - Wins: " + winCount + 
                             " - Level: " + currentLevel);
            
            return currentLevel;
            
        } catch (Exception e) {
            System.err.println("LEVEL CALCULATION ERROR: " + e.getMessage());
            return 1; // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        }
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ±Ù‚ÙŠØ© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
     */
    public LevelUpgradeResult checkLevelUpgradeAsync(String userId, int currentWins) {
        return new Thread(() -> {
            try {
                int currentLevel = calculateCurrentLevel(userId, currentWins);
                User user = UserManager.getInstance(null).getUserById(userId);
                
                if (user == null) {
                    return LevelUpgradeResult.failure("User not found");
                }
                
                int userCurrentLevel = user.getLevel();
                if (currentLevel > userCurrentLevel) {
                    // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    user.setLevel(currentLevel);
                    
                    // Ù…Ù†Ø­ Ø§Ù„Ø´Ø§Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
                    LevelConfig newLevelConfig = levelConfigs.get(currentLevel);
                    if (newLevelConfig != null) {
                        grantLevelBadge(userId, newLevelConfig);
                    }
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ±Ù‚ÙŠØ©
                    logLevelUpgrade(userId, userCurrentLevel, currentLevel);
                    
                    System.out.println("LEVEL SYSTEM: User " + userId + " upgraded from level " + 
                                     userCurrentLevel + " to " + currentLevel);
                    
                    return LevelUpgradeResult.success(
                        userCurrentLevel, 
                        currentLevel, 
                        "Level upgraded successfully"
                    );
                } else {
                    return LevelUpgradeResult.noUpgrade(
                        "User " + userId + " remains at level " + userCurrentLevel
                    );
                }
                
            } catch (Exception e) {
                return LevelUpgradeResult.failure("Level upgrade check failed: " + e.getMessage());
            }
        }).start();
    }

    private void grantLevelBadge(String userId, LevelConfig levelConfig) {
        try {
            User user = UserManager.getInstance(null).getUserById(userId);
            if (user != null) {
                user.addBadge(levelConfig.getBadgeEmoji(), levelConfig.getLevelName());
                System.out.println("LEVEL SYSTEM: Granted badge " + levelConfig.getBadgeEmoji() + 
                                 " to user " + userId + " for level " + levelConfig.getLevel());
                
                // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                Achievements.getInstance().checkAchievement(user, "level_" + levelConfig.getLevel());
            }
            
        } catch (Exception e) {
            System.err.println("BADGE GRANT ERROR: " + e.getMessage());
        }
    }

    private void logLevelUpgrade(String userId, int oldLevel, int newLevel) {
        try {
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            System.out.println("LEVEL UPGRADE LOG: " + userId + " - " + oldLevel + " â†’ " + newLevel + 
                             " at " + Instant.now());
            
        } catch (Exception e) {
            System.err.println("LEVEL UPGRADE LOG ERROR: " + e.getMessage());
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰
     */
    public LevelConfig getLevelConfig(int level) {
        return levelConfigs.getOrDefault(level, getDefaultLevelConfig(level));
    }

    private LevelConfig getDefaultLevelConfig(int level) {
        return new LevelConfig(level, level * 1000, "Ù…Ø³ØªÙˆÙ‰ " + level, "â­", "#FFFFFF");
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§
     */
    public void addDynamicLevel(int level, int requiredWins, String levelName, 
                               String badgeEmoji, String badgeColor) {
        LevelConfig config = new LevelConfig(level, requiredWins, levelName, badgeEmoji, badgeColor);
        levelConfigs.put(level, config);
        System.out.println("LEVEL SYSTEM: Added dynamic level " + level + " - " + levelName);
    }

    /**
     * Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
     */
    public void removeDynamicLevel(int level) {
        LevelConfig removed = levelConfigs.remove(level);
        if (removed != null) {
            System.out.println("LEVEL SYSTEM: Removed dynamic level " + level + " - " + removed.getLevelName());
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
     */
    public void updateLevelBadge(int level, String badgeEmoji, String badgeColor) {
        LevelConfig config = levelConfigs.get(level);
        if (config != null) {
            config.setBadgeEmoji(badgeEmoji);
            config.setBadgeColor(badgeColor);
            System.out.println("LEVEL SYSTEM: Updated badge for level " + level + " - " + badgeEmoji);
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
     */
    public int getLevelCount() {
        return levelConfigs.size();
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰
     */
    public int getMaxLevel() {
        return levelConfigs.keySet().stream().mapToInt(Integer::intValue).max().orElse(1);
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªÙˆÙ‰
     */
    public boolean hasLevel(int level) {
        return levelConfigs.containsKey(level);
    }

    /**
     * Ù…Ø³Ø­ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void clearUserProgress() {
        userProgress.clear();
        System.out.println("LEVEL SYSTEM: Cleared all user progress");
    }

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ---
    public static final class LevelConfig {
        private final int level;
        private final int requiredWins;
        private final String levelName;
        private volatile String badgeEmoji;
        private volatile String badgeColor;

        public LevelConfig(int level, int requiredWins, String levelName, 
                          String badgeEmoji, String badgeColor) {
            this.level = level;
            this.requiredWins = requiredWins;
            this.levelName = levelName;
            this.badgeEmoji = badgeEmoji;
            this.badgeColor = badgeColor;
        }

        // Getters
        public int getLevel() { return level; }
        public int getRequiredWins() { return requiredWins; }
        public String getLevelName() { return levelName; }
        public String getBadgeEmoji() { return badgeEmoji; }
        public String getBadgeColor() { return badgeColor; }
        
        // Setters
        public void setBadgeEmoji(String badgeEmoji) { this.badgeEmoji = badgeEmoji; }
        public void setBadgeColor(String badgeColor) { this.badgeColor = badgeColor; }
        
        @Override
        public String toString() {
            return "LevelConfig{" +
                "level=" + level +
                ", requiredWins=" + requiredWins +
                ", levelName='" + levelName + '\'' +
                ", badgeEmoji='" + badgeEmoji + '\'' +
                ", badgeColor='" + badgeColor + '\'' +
                '}';
        }
    }

    // --- ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
    private static final class UserLevelProgress {
        private final String userId;
        private final AtomicInteger winCount = new AtomicInteger(0);
        private volatile Instant lastUpdate = Instant.now();

        public UserLevelProgress(String userId) {
            this.userId = userId;
        }

        public void updateWinCount(int newWinCount) {
            winCount.set(newWinCount);
            lastUpdate = Instant.now();
        }

        // Getters
        public String getUserId() { return userId; }
        public int getWinCount() { return winCount.get(); }
        public Instant getLastUpdate() { return lastUpdate; }
    }

    // --- Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ±Ù‚ÙŠØ© ---
    public static final class LevelUpgradeResult {
        private final boolean success;
        private final boolean upgraded;
        private final int oldLevel;
        private final int newLevel;
        private final String message;

        private LevelUpgradeResult(boolean success, boolean upgraded, int oldLevel, 
                                 int newLevel, String message) {
            this.success = success;
            this.upgraded = upgraded;
            this.oldLevel = oldLevel;
            this.newLevel = newLevel;
            this.message = message;
        }

        public static LevelUpgradeResult success(int oldLevel, int newLevel, String message) {
            return new LevelUpgradeResult(true, true, oldLevel, newLevel, message);
        }

        public static LevelUpgradeResult noUpgrade(String message) {
            return new LevelUpgradeResult(true, false, 0, 0, message);
        }

        public static LevelUpgradeResult failure(String message) {
            return new LevelUpgradeResult(false, false, 0, 0, message);
        }

        public boolean isSuccess() { return success; }
        public boolean isUpgraded() { return upgraded; }
        public int getOldLevel() { return oldLevel; }
        public int getNewLevel() { return newLevel; }
        public String getMessage() { return message; }
    }

    // --- Getters ---
    public Map<Integer, LevelConfig> getLevelConfigs() { 
        return new ConcurrentHashMap<>(levelConfigs); 
    }
    public Map<String, UserLevelProgress> getUserProgress() { 
        return new ConcurrentHashMap<>(userProgress); 
    }
    
    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
     */
    public void reset() {
        levelConfigs.clear();
        userProgress.clear();
        initializeDefaultLevels();
        System.out.println("LEVEL SYSTEM: Reset completed");
    }
}